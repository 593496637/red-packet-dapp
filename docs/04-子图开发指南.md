# ğŸ“Š Subgraph å¼€å‘å®Œæ•´æŒ‡å—

## ğŸ“‹ å¼€å‘å‰å‡†å¤‡

### ä»€ä¹ˆæ˜¯ The Graph å’Œ Subgraphï¼Ÿ

**The Graph** æ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„åŒºå—é“¾æ•°æ®ç´¢å¼•åè®®ï¼Œå®ƒè®©å¼€å‘è€…èƒ½å¤Ÿå¿«é€Ÿæ„å»ºå’Œå‘å¸ƒå¼€æ”¾çš„APIï¼ˆå­å›¾ï¼‰ï¼Œåº”ç”¨å¯ä»¥ä½¿ç”¨GraphQLæŸ¥è¯¢è¿™äº›æ•°æ®ã€‚

**Subgraph** æ˜¯é’ˆå¯¹ç‰¹å®šæ™ºèƒ½åˆçº¦çš„æ•°æ®ç´¢å¼•å™¨ï¼Œå®ƒï¼š
- ç›‘å¬åŒºå—é“¾ä¸Šçš„äº‹ä»¶
- å¤„ç†å’Œè½¬æ¢æ•°æ®
- æä¾›GraphQL APIä¾›å‰ç«¯æŸ¥è¯¢
- å¤§å¤§æå‡dAppçš„æ•°æ®æŸ¥è¯¢æ€§èƒ½

### ä¸ºä»€ä¹ˆéœ€è¦ Subgraphï¼Ÿ

```
ä¼ ç»Ÿæ–¹å¼æŸ¥è¯¢åŒºå—é“¾æ•°æ®ï¼š
å‰ç«¯ â†’ RPCèŠ‚ç‚¹ â†’ éå†æ‰€æœ‰åŒºå—å’Œäº¤æ˜“ â†’ è¿‡æ»¤äº‹ä»¶ â†’ è¿”å›æ•°æ®
ğŸŒ æ…¢ã€æ¶ˆè€—èµ„æºã€ä½“éªŒå·®

ä½¿ç”¨ Subgraphï¼š
å‰ç«¯ â†’ GraphQL API â†’ å·²ç´¢å¼•çš„æ•°æ®åº“ â†’ å¿«é€Ÿè¿”å›ç»“æ„åŒ–æ•°æ®  
âš¡ å¿«ã€é«˜æ•ˆã€ç”¨æˆ·ä½“éªŒå¥½
```

### çº¢åŒ…ç³»ç»Ÿçš„æ•°æ®éœ€æ±‚åˆ†æ

1. **çº¢åŒ…åˆ—è¡¨æŸ¥è¯¢**
   - æŒ‰æ—¶é—´æ’åºçš„æ‰€æœ‰çº¢åŒ…
   - æŒ‰åˆ›å»ºè€…è¿‡æ»¤çš„çº¢åŒ…
   - çº¢åŒ…çŠ¶æ€ç»Ÿè®¡

2. **çº¢åŒ…è¯¦æƒ…æŸ¥è¯¢**
   - çº¢åŒ…åŸºæœ¬ä¿¡æ¯
   - æ‰€æœ‰é¢†å–è®°å½•
   - é¢†å–è¿›åº¦ç»Ÿè®¡

3. **ç”¨æˆ·ç»Ÿè®¡æ•°æ®**
   - ç”¨æˆ·åˆ›å»ºçš„çº¢åŒ…æ•°é‡
   - ç”¨æˆ·é¢†å–çš„çº¢åŒ…æ•°é‡
   - ç”¨æˆ·çš„æ”¶æ”¯ç»Ÿè®¡

## ğŸ—ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. å®‰è£… Graph CLI

```bash
# å…¨å±€å®‰è£… Graph CLI
npm install -g @graphprotocol/graph-cli

# éªŒè¯å®‰è£…
graph --version
```

### 2. åˆå§‹åŒ– Subgraph é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir red-packet-subgraph
cd red-packet-subgraph

# åˆå§‹åŒ– subgraph
graph init \
  --studio \
  red-packet-subgraph \
  --from-contract 0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f \
  --network sepolia \
  --contract-name RedPacketSystem

# æˆ–è€…ä»ç°æœ‰ç›®å½•åˆå§‹åŒ–
graph init --from-contract 0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f --network sepolia
```

### 3. é¡¹ç›®ç»“æ„è§£æ

```
red-packet-subgraph/
â”œâ”€â”€ schema.graphql         # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ subgraph.yaml         # å­å›¾é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â””â”€â”€ mapping.ts        # äº‹ä»¶å¤„ç†é€»è¾‘
â”œâ”€â”€ generated/            # è‡ªåŠ¨ç”Ÿæˆçš„ç±»å‹æ–‡ä»¶
â”œâ”€â”€ build/               # æ„å»ºè¾“å‡º
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### 4. æ ¸å¿ƒé…ç½®æ–‡ä»¶

**package.json**:
```json
{
  "name": "red-packet-subgraph",
  "version": "0.1.0",
  "description": "Subgraph for Red Packet DApp",
  "scripts": {
    "codegen": "graph codegen",
    "build": "graph build",
    "deploy": "graph deploy --studio red-packet-subgraph",
    "create-local": "graph create --node http://localhost:8020/ red-packet-subgraph",
    "remove-local": "graph remove --node http://localhost:8020/ red-packet-subgraph",
    "deploy-local": "graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 red-packet-subgraph",
    "test": "graph test"
  },
  "dependencies": {
    "@graphprotocol/graph-cli": "^0.69.0",
    "@graphprotocol/graph-ts": "^0.34.0"
  }
}
```

## ğŸ’¡ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. GraphQL Schema è®¾è®¡

**schema.graphql**:
```graphql
# çº¢åŒ…å®ä½“
type RedPacket @entity {
  id: ID!                           # çº¢åŒ…ID
  creator: Bytes!                   # åˆ›å»ºè€…åœ°å€
  message: String!                  # ç¥ç¦è¯­
  totalAmount: BigInt!              # æ€»é‡‘é¢ï¼ˆweiï¼‰
  balance: BigInt!                  # å‰©ä½™é‡‘é¢ï¼ˆweiï¼‰  
  totalCount: Int!                  # æ€»ä»½æ•°
  claimedCount: Int!                # å·²é¢†å–ä»½æ•°
  isEven: Boolean!                  # æ˜¯å¦å‡åˆ†æ¨¡å¼
  creationTime: BigInt!             # åˆ›å»ºæ—¶é—´æˆ³
  blockNumber: BigInt!              # åˆ›å»ºåŒºå—å·
  transactionHash: Bytes!           # äº¤æ˜“å“ˆå¸Œ
  
  # å…³è”å…³ç³»
  claims: [Claim!]! @derivedFrom(field: "redPacket")  # æ‰€æœ‰é¢†å–è®°å½•
  
  # è®¡ç®—å­—æ®µï¼ˆåœ¨mappingä¸­è®¡ç®—ï¼‰
  isActive: Boolean!                # æ˜¯å¦ä»å¯é¢†å–
  averageAmount: BigInt!            # å¹³å‡é‡‘é¢
  completionRate: BigDecimal!       # å®Œæˆç‡ (0-1)
}

# é¢†å–è®°å½•å®ä½“
type Claim @entity {
  id: ID!                          # é¢†å–è®°å½•ID (packetId-claimer)
  redPacket: RedPacket!            # å…³è”çš„çº¢åŒ…
  claimer: Bytes!                  # é¢†å–è€…åœ°å€
  amount: BigInt!                  # é¢†å–é‡‘é¢ï¼ˆweiï¼‰
  timestamp: BigInt!               # é¢†å–æ—¶é—´æˆ³
  blockNumber: BigInt!             # é¢†å–åŒºå—å·
  transactionHash: Bytes!          # äº¤æ˜“å“ˆå¸Œ
  claimIndex: Int!                 # é¢†å–åºå·ï¼ˆç¬¬å‡ ä¸ªé¢†å–ï¼‰
}

# ç”¨æˆ·ç»Ÿè®¡å®ä½“
type User @entity {
  id: ID!                          # ç”¨æˆ·åœ°å€
  address: Bytes!                  # ç”¨æˆ·åœ°å€
  
  # åˆ›å»ºç»Ÿè®¡
  createdPacketsCount: Int!        # åˆ›å»ºçº¢åŒ…æ•°é‡
  totalAmountCreated: BigInt!      # åˆ›å»ºçº¢åŒ…æ€»é‡‘é¢
  createdPackets: [RedPacket!]! @derivedFrom(field: "creator")
  
  # é¢†å–ç»Ÿè®¡
  claimedPacketsCount: Int!        # é¢†å–çº¢åŒ…æ•°é‡
  totalAmountClaimed: BigInt!      # é¢†å–çº¢åŒ…æ€»é‡‘é¢
  claims: [Claim!]! @derivedFrom(field: "claimer")
  
  # æ—¶é—´ç»Ÿè®¡
  firstActivity: BigInt!           # é¦–æ¬¡æ´»åŠ¨æ—¶é—´
  lastActivity: BigInt!            # æœ€åæ´»åŠ¨æ—¶é—´
}

# å…¨å±€ç»Ÿè®¡å®ä½“
type GlobalStats @entity {
  id: ID!                          # å›ºå®šä¸º "global"
  totalPackets: Int!               # æ€»çº¢åŒ…æ•°é‡
  totalAmount: BigInt!             # æ€»é‡‘é¢
  totalClaims: Int!                # æ€»é¢†å–æ¬¡æ•°
  activePackets: Int!              # æ´»è·ƒçº¢åŒ…æ•°é‡
  totalUsers: Int!                 # æ€»ç”¨æˆ·æ•°
  lastUpdated: BigInt!             # æœ€åæ›´æ–°æ—¶é—´
}

# æ¯æ—¥ç»Ÿè®¡å®ä½“
type DayStats @entity {
  id: ID!                          # æ ¼å¼: "YYYY-MM-DD"
  date: Int!                       # æ—¥æœŸæˆ³
  packetsCreated: Int!             # å½“æ—¥åˆ›å»ºçº¢åŒ…æ•°
  packetsClaimed: Int!             # å½“æ—¥é¢†å–çº¢åŒ…æ•°  
  amountCreated: BigInt!           # å½“æ—¥åˆ›å»ºé‡‘é¢
  amountClaimed: BigInt!           # å½“æ—¥é¢†å–é‡‘é¢
  activeUsers: Int!                # å½“æ—¥æ´»è·ƒç”¨æˆ·æ•°
}
```

### 2. æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™

1. **å®ä½“å…³ç³»è®¾è®¡**
   - `RedPacket` â†” `Claim`: ä¸€å¯¹å¤šå…³ç³»
   - `User` â†” `RedPacket`: ä¸€å¯¹å¤šå…³ç³»ï¼ˆåˆ›å»ºè€…ï¼‰
   - `User` â†” `Claim`: ä¸€å¯¹å¤šå…³ç³»ï¼ˆé¢†å–è€…ï¼‰

2. **ç´¢å¼•ä¼˜åŒ–**
   - ç»å¸¸æŸ¥è¯¢çš„å­—æ®µè®¾ä¸ºç´¢å¼•
   - æ—¶é—´å­—æ®µç”¨äºæ’åºå’Œè¿‡æ»¤
   - å…³è”å­—æ®µæå‡æŸ¥è¯¢æ€§èƒ½

3. **è®¡ç®—å­—æ®µ**
   - å®æ—¶è®¡ç®—çš„çŠ¶æ€å­—æ®µ
   - èšåˆç»Ÿè®¡æ•°æ®
   - ä¾¿äºå‰ç«¯ç›´æ¥ä½¿ç”¨

## ğŸ”§ äº‹ä»¶å¤„ç†é€»è¾‘å®ç°

### 1. Subgraph é…ç½®

**subgraph.yaml**:
```yaml
specVersion: 1.0.0
indexerHints:
  prune: auto
schema:
  file: ./schema.graphql
dataSources:
  - kind: ethereum
    name: RedPacketSystem
    network: sepolia
    source:
      address: "0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f"
      abi: RedPacketSystem
      startBlock: 4800000  # åˆçº¦éƒ¨ç½²çš„åŒºå—å·
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - RedPacket
        - Claim
        - User
        - GlobalStats
        - DayStats
      abis:
        - name: RedPacketSystem
          file: ./abis/RedPacketSystem.json
      eventHandlers:
        - event: PacketCreated(indexed uint256,indexed address,string,uint256,uint256,bool)
          handler: handlePacketCreated
        - event: PacketClaimed(indexed uint256,indexed address,uint256)
          handler: handlePacketClaimed
        - event: PacketEmpty(indexed uint256)
          handler: handlePacketEmpty
        - event: FundsWithdrawn(indexed uint256,indexed address,uint256)
          handler: handleFundsWithdrawn
      file: ./src/mapping.ts
```

### 2. æ˜ å°„é€»è¾‘å®ç°

**src/mapping.ts**:
```typescript
import {
  PacketCreated,
  PacketClaimed,
  PacketEmpty,
  FundsWithdrawn
} from "../generated/RedPacketSystem/RedPacketSystem"

import {
  RedPacket,
  Claim,
  User,
  GlobalStats,
  DayStats
} from "../generated/schema"

import {
  BigInt,
  BigDecimal,
  Address,
  Bytes
} from "@graphprotocol/graph-ts"

// å¸¸é‡å®šä¹‰
const GLOBAL_STATS_ID = "global"
const ZERO_BI = BigInt.fromI32(0)
const ONE_BI = BigInt.fromI32(1)

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºç”¨æˆ·å®ä½“
function getOrCreateUser(address: Address): User {
  let user = User.load(address.toHex())
  
  if (user === null) {
    user = new User(address.toHex())
    user.address = address
    user.createdPacketsCount = 0
    user.totalAmountCreated = ZERO_BI
    user.claimedPacketsCount = 0
    user.totalAmountClaimed = ZERO_BI
    user.firstActivity = ZERO_BI
    user.lastActivity = ZERO_BI
    user.save()
    
    // æ›´æ–°å…¨å±€ç”¨æˆ·ç»Ÿè®¡
    updateGlobalUserCount()
  }
  
  return user
}

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºå…¨å±€ç»Ÿè®¡
function getOrCreateGlobalStats(): GlobalStats {
  let stats = GlobalStats.load(GLOBAL_STATS_ID)
  
  if (stats === null) {
    stats = new GlobalStats(GLOBAL_STATS_ID)
    stats.totalPackets = 0
    stats.totalAmount = ZERO_BI
    stats.totalClaims = 0
    stats.activePackets = 0
    stats.totalUsers = 0
    stats.lastUpdated = ZERO_BI
  }
  
  return stats
}

// å·¥å…·å‡½æ•°ï¼šè·å–æ¯æ—¥ç»Ÿè®¡ID
function getDayStatsId(timestamp: BigInt): string {
  const date = new Date(timestamp.toI32() * 1000)
  const year = date.getUTCFullYear()
  const month = date.getUTCMonth() + 1
  const day = date.getUTCDate()
  
  const monthStr = month < 10 ? "0" + month.toString() : month.toString()
  const dayStr = day < 10 ? "0" + day.toString() : day.toString()
  
  return year.toString() + "-" + monthStr + "-" + dayStr
}

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºæ¯æ—¥ç»Ÿè®¡
function getOrCreateDayStats(timestamp: BigInt): DayStats {
  const dayStatsId = getDayStatsId(timestamp)
  let dayStats = DayStats.load(dayStatsId)
  
  if (dayStats === null) {
    dayStats = new DayStats(dayStatsId)
    const date = new Date(timestamp.toI32() * 1000)
    dayStats.date = BigInt.fromI32(Math.floor(date.getTime() / 1000 / 86400) * 86400)
    dayStats.packetsCreated = 0
    dayStats.packetsClaimed = 0
    dayStats.amountCreated = ZERO_BI
    dayStats.amountClaimed = ZERO_BI
    dayStats.activeUsers = 0
  }
  
  return dayStats
}

// å·¥å…·å‡½æ•°ï¼šæ›´æ–°å…¨å±€ç”¨æˆ·æ•°é‡
function updateGlobalUserCount(): void {
  let stats = getOrCreateGlobalStats()
  stats.totalUsers = stats.totalUsers + 1
  stats.save()
}

// å·¥å…·å‡½æ•°ï¼šè®¡ç®—å®Œæˆç‡
function calculateCompletionRate(claimedCount: i32, totalCount: i32): BigDecimal {
  if (totalCount === 0) {
    return BigDecimal.fromString("0")
  }
  return BigDecimal.fromString(claimedCount.toString()).div(BigDecimal.fromString(totalCount.toString()))
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…åˆ›å»º
export function handlePacketCreated(event: PacketCreated): void {
  // åˆ›å»ºçº¢åŒ…å®ä½“
  let redPacket = new RedPacket(event.params.packetId.toString())
  
  redPacket.creator = event.params.creator
  redPacket.message = event.params.message
  redPacket.totalAmount = event.params.totalAmount
  redPacket.balance = event.params.totalAmount  // åˆå§‹ä½™é¢ç­‰äºæ€»é‡‘é¢
  redPacket.totalCount = event.params.totalCount.toI32()
  redPacket.claimedCount = 0
  redPacket.isEven = event.params.isEven
  redPacket.creationTime = event.block.timestamp
  redPacket.blockNumber = event.block.number
  redPacket.transactionHash = event.transaction.hash
  
  // è®¡ç®—å­—æ®µ
  redPacket.isActive = true
  redPacket.averageAmount = event.params.totalAmount.div(BigInt.fromI32(event.params.totalCount.toI32()))
  redPacket.completionRate = BigDecimal.fromString("0")
  
  redPacket.save()

  // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
  let creator = getOrCreateUser(event.params.creator)
  creator.createdPacketsCount = creator.createdPacketsCount + 1
  creator.totalAmountCreated = creator.totalAmountCreated.plus(event.params.totalAmount)
  
  if (creator.firstActivity.equals(ZERO_BI)) {
    creator.firstActivity = event.block.timestamp
  }
  creator.lastActivity = event.block.timestamp
  creator.save()

  // æ›´æ–°å…¨å±€ç»Ÿè®¡
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalPackets = globalStats.totalPackets + 1
  globalStats.totalAmount = globalStats.totalAmount.plus(event.params.totalAmount)
  globalStats.activePackets = globalStats.activePackets + 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()

  // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
  let dayStats = getOrCreateDayStats(event.block.timestamp)
  dayStats.packetsCreated = dayStats.packetsCreated + 1
  dayStats.amountCreated = dayStats.amountCreated.plus(event.params.totalAmount)
  dayStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…é¢†å–
export function handlePacketClaimed(event: PacketClaimed): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    // è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§
    return
  }

  // åˆ›å»ºé¢†å–è®°å½•
  let claimId = event.params.packetId.toString() + "-" + event.params.claimer.toHex()
  let claim = new Claim(claimId)
  
  claim.redPacket = redPacket.id
  claim.claimer = event.params.claimer
  claim.amount = event.params.amount
  claim.timestamp = event.block.timestamp
  claim.blockNumber = event.block.number
  claim.transactionHash = event.transaction.hash
  claim.claimIndex = redPacket.claimedCount + 1  // é¢†å–åºå·
  
  claim.save()

  // æ›´æ–°çº¢åŒ…çŠ¶æ€
  redPacket.claimedCount = redPacket.claimedCount + 1
  redPacket.balance = redPacket.balance.minus(event.params.amount)
  redPacket.completionRate = calculateCompletionRate(redPacket.claimedCount, redPacket.totalCount)
  
  // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½é¢†å–
  if (redPacket.claimedCount >= redPacket.totalCount) {
    redPacket.isActive = false
  }
  
  redPacket.save()

  // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
  let claimer = getOrCreateUser(event.params.claimer)
  claimer.claimedPacketsCount = claimer.claimedPacketsCount + 1
  claimer.totalAmountClaimed = claimer.totalAmountClaimed.plus(event.params.amount)
  
  if (claimer.firstActivity.equals(ZERO_BI)) {
    claimer.firstActivity = event.block.timestamp
  }
  claimer.lastActivity = event.block.timestamp
  claimer.save()

  // æ›´æ–°å…¨å±€ç»Ÿè®¡
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalClaims = globalStats.totalClaims + 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()

  // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
  let dayStats = getOrCreateDayStats(event.block.timestamp)
  dayStats.packetsClaimed = dayStats.packetsClaimed + 1
  dayStats.amountClaimed = dayStats.amountClaimed.plus(event.params.amount)
  dayStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…æŠ¢å®Œ
export function handlePacketEmpty(event: PacketEmpty): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    return
  }

  // ç¡®ä¿çº¢åŒ…çŠ¶æ€æ­£ç¡®
  redPacket.isActive = false
  redPacket.completionRate = BigDecimal.fromString("1")
  redPacket.save()

  // æ›´æ–°å…¨å±€æ´»è·ƒçº¢åŒ…æ•°é‡
  let globalStats = getOrCreateGlobalStats()
  globalStats.activePackets = globalStats.activePackets - 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šèµ„é‡‘æå–
export function handleFundsWithdrawn(event: FundsWithdrawn): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    return
  }

  // æ›´æ–°çº¢åŒ…çŠ¶æ€
  redPacket.balance = ZERO_BI
  redPacket.isActive = false
  redPacket.save()

  // æ›´æ–°å…¨å±€æ´»è·ƒçº¢åŒ…æ•°é‡
  let globalStats = getOrCreateGlobalStats()
  if (redPacket.isActive) {
    globalStats.activePackets = globalStats.activePackets - 1
  }
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()
}
```

### 3. é«˜çº§æŸ¥è¯¢ä¼˜åŒ–

ä¸ºäº†æä¾›æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ˜ å°„ä¸­æ·»åŠ ä¸€äº›ç´¢å¼•å­—æ®µï¼š

```typescript
// åœ¨ handlePacketCreated ä¸­æ·»åŠ 
redPacket.creatorLowerCase = event.params.creator.toHex().toLowerCase()  // ä¾¿äºæœç´¢
redPacket.dayCreated = getDayStatsId(event.block.timestamp)              // ä¾¿äºæŒ‰å¤©è¿‡æ»¤

// åœ¨ handlePacketClaimed ä¸­æ·»åŠ   
claim.claimerLowerCase = event.params.claimer.toHex().toLowerCase()      // ä¾¿äºæœç´¢
claim.dayCreated = getDayStatsId(event.block.timestamp)                  // ä¾¿äºæŒ‰å¤©è¿‡æ»¤
```

## ğŸ§ª æµ‹è¯•ä¸è°ƒè¯•

### 1. æœ¬åœ°æµ‹è¯•ç¯å¢ƒæ­å»º

**å®‰è£… Matchstick æµ‹è¯•æ¡†æ¶**:
```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
npm install --save-dev matchstick-as

# åˆ›å»ºæµ‹è¯•ç›®å½•
mkdir tests
```

**tests/red-packet-system.test.ts**:
```typescript
import {
  test,
  assert,
  describe,
  beforeEach,
  clearStore,
  createMockedFunction,
  newMockEvent
} from "matchstick-as/assembly/index"

import { 
  handlePacketCreated,
  handlePacketClaimed 
} from "../src/mapping"

import { PacketCreated, PacketClaimed } from "../generated/RedPacketSystem/RedPacketSystem"
import { RedPacket, Claim } from "../generated/schema"
import { BigInt, Address, ethereum } from "@graphprotocol/graph-ts"

// æµ‹è¯•å·¥å…·å‡½æ•°
function createPacketCreatedEvent(
  packetId: BigInt,
  creator: Address,
  message: string,
  totalAmount: BigInt,
  totalCount: BigInt,
  isEven: boolean
): PacketCreated {
  let event = changetype<PacketCreated>(newMockEvent())
  
  event.parameters = []
  
  event.parameters.push(
    new ethereum.EventParam("packetId", ethereum.Value.fromUnsignedBigInt(packetId))
  )
  event.parameters.push(
    new ethereum.EventParam("creator", ethereum.Value.fromAddress(creator))
  )
  event.parameters.push(
    new ethereum.EventParam("message", ethereum.Value.fromString(message))
  )
  event.parameters.push(
    new ethereum.EventParam("totalAmount", ethereum.Value.fromUnsignedBigInt(totalAmount))
  )
  event.parameters.push(
    new ethereum.EventParam("totalCount", ethereum.Value.fromUnsignedBigInt(totalCount))
  )
  event.parameters.push(
    new ethereum.EventParam("isEven", ethereum.Value.fromBoolean(isEven))
  )

  return event
}

function createPacketClaimedEvent(
  packetId: BigInt,
  claimer: Address,
  amount: BigInt
): PacketClaimed {
  let event = changetype<PacketClaimed>(newMockEvent())
  
  event.parameters = []
  
  event.parameters.push(
    new ethereum.EventParam("packetId", ethereum.Value.fromUnsignedBigInt(packetId))
  )
  event.parameters.push(
    new ethereum.EventParam("claimer", ethereum.Value.fromAddress(claimer))
  )
  event.parameters.push(
    new ethereum.EventParam("amount", ethereum.Value.fromUnsignedBigInt(amount))
  )

  return event
}

// æµ‹è¯•ç”¨ä¾‹
describe("Red Packet System", () => {
  beforeEach(() => {
    clearStore() // æ¸…ç†æµ‹è¯•å­˜å‚¨
  })

  test("Should create red packet correctly", () => {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let message = "Happy New Year!"
    let totalAmount = BigInt.fromString("1000000000000000000") // 1 ETH
    let totalCount = BigInt.fromI32(5)
    let isEven = true

    // åˆ›å»ºå¹¶å¤„ç†äº‹ä»¶
    let event = createPacketCreatedEvent(packetId, creator, message, totalAmount, totalCount, isEven)
    handlePacketCreated(event)

    // éªŒè¯çº¢åŒ…å®ä½“
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.bytesEquals(redPacket.creator, creator)
      assert.stringEquals(redPacket.message, message)
      assert.bigIntEquals(redPacket.totalAmount, totalAmount)
      assert.bigIntEquals(redPacket.balance, totalAmount)
      assert.i32Equals(redPacket.totalCount, 5)
      assert.i32Equals(redPacket.claimedCount, 0)
      assert.booleanEquals(redPacket.isEven, true)
      assert.booleanEquals(redPacket.isActive, true)
    }
  })

  test("Should handle red packet claim correctly", () => {
    // å…ˆåˆ›å»ºçº¢åŒ…
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let claimer = Address.fromString("0x0987654321098765432109876543210987654321")
    
    let createEvent = createPacketCreatedEvent(
      packetId,
      creator,
      "Test packet",
      BigInt.fromString("1000000000000000000"),
      BigInt.fromI32(2),
      false
    )
    handlePacketCreated(createEvent)

    // ç„¶åå¤„ç†é¢†å–äº‹ä»¶
    let claimAmount = BigInt.fromString("600000000000000000") // 0.6 ETH
    let claimEvent = createPacketClaimedEvent(packetId, claimer, claimAmount)
    handlePacketClaimed(claimEvent)

    // éªŒè¯çº¢åŒ…çŠ¶æ€æ›´æ–°
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.i32Equals(redPacket.claimedCount, 1)
      assert.bigIntEquals(redPacket.balance, BigInt.fromString("400000000000000000"))
      assert.booleanEquals(redPacket.isActive, true) // è¿˜æœ‰1ä»½æ²¡é¢†å–
    }

    // éªŒè¯é¢†å–è®°å½•
    let claimId = "1-" + claimer.toHex()
    let claim = Claim.load(claimId)
    assert.assertNotNull(claim)
    
    if (claim !== null) {
      assert.stringEquals(claim.redPacket, "1")
      assert.bytesEquals(claim.claimer, claimer)
      assert.bigIntEquals(claim.amount, claimAmount)
      assert.i32Equals(claim.claimIndex, 1)
    }
  })

  test("Should mark red packet as inactive when fully claimed", () => {
    // åˆ›å»ºåªæœ‰1ä»½çš„çº¢åŒ…
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let claimer = Address.fromString("0x0987654321098765432109876543210987654321")
    
    let createEvent = createPacketCreatedEvent(
      packetId,
      creator,
      "Single packet",
      BigInt.fromString("1000000000000000000"),
      BigInt.fromI32(1),
      true
    )
    handlePacketCreated(createEvent)

    // é¢†å–è¿™å”¯ä¸€çš„çº¢åŒ…
    let claimEvent = createPacketClaimedEvent(
      packetId, 
      claimer, 
      BigInt.fromString("1000000000000000000")
    )
    handlePacketClaimed(claimEvent)

    // éªŒè¯çº¢åŒ…å˜ä¸ºéæ´»è·ƒçŠ¶æ€
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.i32Equals(redPacket.claimedCount, 1)
      assert.bigIntEquals(redPacket.balance, BigInt.fromI32(0))
      assert.booleanEquals(redPacket.isActive, false)
      assert.stringEquals(redPacket.completionRate.toString(), "1")
    }
  })
})
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# ç”Ÿæˆç±»å‹æ–‡ä»¶
npm run codegen

# è¿è¡Œæµ‹è¯•
graph test
```

## ğŸš€ éƒ¨ç½²ä¸å‘å¸ƒ

### 1. å‡†å¤‡éƒ¨ç½²

```bash
# ç”Ÿæˆç±»å‹å’Œæ„å»º
npm run codegen
npm run build
```

### 2. éƒ¨ç½²åˆ° Graph Studio

```bash
# é¦–å…ˆéœ€è¦åœ¨ https://thegraph.com/studio/ åˆ›å»ºå­å›¾

# æˆæƒï¼ˆéœ€è¦ä»Studioè·å–è®¿é—®ä»¤ç‰Œï¼‰
graph auth --studio YOUR_ACCESS_TOKEN

# éƒ¨ç½²
npm run deploy
```

### 3. ç‰ˆæœ¬ç®¡ç†

**éƒ¨ç½²å¤šä¸ªç‰ˆæœ¬**:
```bash
# éƒ¨ç½²åˆ°ä¸åŒæ ‡ç­¾
graph deploy --studio red-packet-subgraph --version-label v1.0.0
graph deploy --studio red-packet-subgraph --version-label v1.0.1
```

### 4. ç›‘æ§ä¸ç»´æŠ¤

**æ£€æŸ¥åŒæ­¥çŠ¶æ€**:
```bash
# é€šè¿‡GraphQLæŸ¥è¯¢å­å›¾çŠ¶æ€
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"query": "{ _meta { block { number } } }"}' \
  https://api.studio.thegraph.com/query/your-subgraph-id/your-subgraph-name/version/latest
```

## ğŸ“Š å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. åŸºç¡€æŸ¥è¯¢

```graphql
# è·å–æœ€æ–°çš„20ä¸ªçº¢åŒ…
query GetRecentPackets {
  redPackets(
    first: 20
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    totalCount
    claimedCount
    isEven
    isActive
    creationTime
    claims {
      claimer
      amount
      timestamp
    }
  }
}

# è·å–ç”¨æˆ·åˆ›å»ºçš„çº¢åŒ…
query GetUserPackets($creator: Bytes!) {
  redPackets(
    where: { creator: $creator }
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    message
    totalAmount
    totalCount
    claimedCount
    isActive
    completionRate
  }
}

# è·å–ç”¨æˆ·çš„é¢†å–è®°å½•
query GetUserClaims($claimer: Bytes!) {
  claims(
    where: { claimer: $claimer }
    orderBy: timestamp
    orderDirection: desc
  ) {
    id
    redPacket {
      id
      message
      creator
    }
    amount
    timestamp
    claimIndex
  }
}
```

### 2. ç»Ÿè®¡æŸ¥è¯¢

```graphql
# è·å–å…¨å±€ç»Ÿè®¡
query GetGlobalStats {
  globalStats(id: "global") {
    totalPackets
    totalAmount
    totalClaims
    activePackets
    totalUsers
    lastUpdated
  }
}

# è·å–æ¯æ—¥ç»Ÿè®¡
query GetDayStats($startDate: String!, $endDate: String!) {
  dayStats(
    where: {
      id_gte: $startDate
      id_lte: $endDate
    }
    orderBy: date
    orderDirection: asc
  ) {
    id
    date
    packetsCreated
    packetsClaimed
    amountCreated
    amountClaimed
    activeUsers
  }
}

# è·å–ç”¨æˆ·ç»Ÿè®¡
query GetUserStats($userId: ID!) {
  user(id: $userId) {
    address
    createdPacketsCount
    totalAmountCreated
    claimedPacketsCount
    totalAmountClaimed
    firstActivity
    lastActivity
  }
}
```

### 3. å¤æ‚æŸ¥è¯¢

```graphql
# è·å–æ´»è·ƒçº¢åŒ…ï¼ˆå¯é¢†å–çš„ï¼‰
query GetActivePackets($first: Int = 10) {
  redPackets(
    where: { isActive: true }
    first: $first
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    balance
    totalCount
    claimedCount
    averageAmount
    completionRate
  }
}

# è·å–å¤§é¢çº¢åŒ…ï¼ˆæ€»é‡‘é¢å¤§äº1 ETHï¼‰
query GetLargePackets {
  redPackets(
    where: { totalAmount_gte: "1000000000000000000" }
    orderBy: totalAmount
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    totalCount
    isEven
    creationTime
  }
}

# è·å–çº¢åŒ…è¯¦æƒ…å’Œæ‰€æœ‰é¢†å–è®°å½•
query GetPacketDetails($packetId: ID!) {
  redPacket(id: $packetId) {
    id
    creator
    message
    totalAmount
    balance
    totalCount
    claimedCount
    isEven
    isActive
    creationTime
    completionRate
    claims(orderBy: timestamp, orderDirection: asc) {
      claimer
      amount
      timestamp
      claimIndex
      transactionHash
    }
  }
}
```

## ğŸ› ï¸ è°ƒè¯•ä¸ä¼˜åŒ–

### 1. è°ƒè¯•æŠ€å·§

**æ—¥å¿—è°ƒè¯•**:
```typescript
import { log } from "@graphprotocol/graph-ts"

export function handlePacketCreated(event: PacketCreated): void {
  log.info("Processing PacketCreated event for packet {}", [event.params.packetId.toString()])
  
  // å¤„ç†é€»è¾‘...
  
  log.info("Successfully processed packet {} with amount {}", [
    event.params.packetId.toString(),
    event.params.totalAmount.toString()
  ])
}
```

**é”™è¯¯å¤„ç†**:
```typescript
export function handlePacketClaimed(event: PacketClaimed): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    log.error("RedPacket with id {} not found", [event.params.packetId.toString()])
    return  // ä¼˜é›…å¤„ç†é”™è¯¯ï¼Œä¸è¦è®©å­å›¾å¤±è´¥
  }

  // ç»§ç»­å¤„ç†...
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡æ“ä½œ**:
```typescript
// é¿å…åœ¨å¾ªç¯ä¸­å¤šæ¬¡ä¿å­˜åŒä¸€ä¸ªå®ä½“
let user = getOrCreateUser(event.params.creator)
user.createdPacketsCount = user.createdPacketsCount + 1
user.totalAmountCreated = user.totalAmountCreated.plus(event.params.totalAmount)
user.lastActivity = event.block.timestamp
user.save() // åªä¿å­˜ä¸€æ¬¡
```

**åˆç†çš„å®ä½“å…³ç³»**:
```typescript
// ä½¿ç”¨ @derivedFrom é¿å…æ‰‹åŠ¨ç»´æŠ¤åŒå‘å…³ç³»
// åœ¨ schema.graphql ä¸­ï¼š
# claims: [Claim!]! @derivedFrom(field: "redPacket")
```

### 3. ç›‘æ§æŒ‡æ ‡

**ç›‘æ§å­å›¾å¥åº·çŠ¶æ€**:
```typescript
// åœ¨æ˜ å°„ä¸­æ·»åŠ å¥åº·æ£€æŸ¥
let globalStats = getOrCreateGlobalStats()
globalStats.lastUpdated = event.block.timestamp

// å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ›´æ–°ï¼Œè¯´æ˜å¯èƒ½æœ‰é—®é¢˜
if (event.block.timestamp.gt(globalStats.lastUpdated.plus(BigInt.fromI32(3600)))) {
  log.warning("Subgraph might be lagging, last update was {} seconds ago", [
    event.block.timestamp.minus(globalStats.lastUpdated).toString()
  ])
}
```

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### 1. æ•°æ®æ¨¡å‹è®¾è®¡
- **å®ä½“å…³ç³»æ¸…æ™°**: åˆç†è®¾è®¡ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»
- **å­—æ®µç±»å‹é€‰æ‹©**: ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹ï¼ˆBigInt for wei amountsï¼‰
- **ç´¢å¼•ç­–ç•¥**: ç»å¸¸æŸ¥è¯¢çš„å­—æ®µæ·»åŠ ç´¢å¼•
- **è®¡ç®—å­—æ®µ**: åœ¨æ˜ å°„ä¸­è®¡ç®—å¸¸ç”¨çš„æ´¾ç”Ÿå­—æ®µ

### 2. æ˜ å°„é€»è¾‘
- **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†ç©ºå€¼å’Œå¼‚å¸¸æƒ…å†µ
- **æ€§èƒ½ä¼˜åŒ–**: é¿å…ä¸å¿…è¦çš„å®ä½“åŠ è½½å’Œä¿å­˜
- **æ—¥å¿—è®°å½•**: åˆç†æ·»åŠ æ—¥å¿—ç”¨äºè°ƒè¯•
- **ç‰ˆæœ¬å…¼å®¹**: è€ƒè™‘åˆçº¦å‡çº§å’Œæ•°æ®è¿ç§»

### 3. æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æµ‹è¯•æ¯ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°
- **é›†æˆæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- **è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•æç«¯æƒ…å†µå’Œé”™è¯¯å¤„ç†
- **æ€§èƒ½æµ‹è¯•**: ç¡®ä¿å¤§é‡æ•°æ®ä¸‹çš„æ€§èƒ½

### 4. éƒ¨ç½²è¿ç»´
- **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬å·ç®¡ç†å­å›¾ç‰ˆæœ¬
- **ç›‘æ§å‘Šè­¦**: ç›‘æ§åŒæ­¥çŠ¶æ€å’ŒæŸ¥è¯¢æ€§èƒ½
- **å¤‡ä»½ç­–ç•¥**: é‡è¦æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤
- **æ–‡æ¡£ç»´æŠ¤**: ä¿æŒæŸ¥è¯¢æ–‡æ¡£å’ŒAPIæ–‡æ¡£æœ€æ–°

é€šè¿‡è¿™å¥—å®Œæ•´çš„Subgraphå¼€å‘æŒ‡å—ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªé«˜æ•ˆã€å¯é ã€å¯æ‰©å±•çš„æ•°æ®ç´¢å¼•ç³»ç»Ÿï¼Œä¸ºçº¢åŒ…DAppæä¾›äº†å¼ºå¤§çš„æ•°æ®æ”¯æŒï¼Œæ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒå’Œåº”ç”¨æ€§èƒ½ã€‚