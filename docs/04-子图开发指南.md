# ğŸ“Š The Graph å­å›¾å¼€å‘å®æˆ˜æ•™ç¨‹

> **æ‰‹æŠŠæ‰‹æ•™ä½ æ„å»ºé«˜æ€§èƒ½çš„åŒºå—é“¾æ•°æ®ç´¢å¼•ç³»ç»Ÿ**

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡è¿™ä¸ªæ•™ç¨‹ï¼Œä½ å°†å­¦ä¼šï¼š
- âœ… ç†è§£ The Graph åè®®å’Œå­å›¾çš„å·¥ä½œåŸç†
- âœ… ä»é›¶å¼€å§‹æ­å»ºå­å›¾å¼€å‘ç¯å¢ƒ
- âœ… è®¾è®¡é«˜æ•ˆçš„æ•°æ®æ¨¡å‹å’Œå…³ç³»
- âœ… ç¼–å†™å¤æ‚çš„äº‹ä»¶å¤„ç†é€»è¾‘
- âœ… æµ‹è¯•ã€éƒ¨ç½²å’Œä¼˜åŒ–å­å›¾æ€§èƒ½
- âœ… åœ¨å‰ç«¯åº”ç”¨ä¸­é›†æˆGraphQLæŸ¥è¯¢

## ğŸ“š å‰ç½®çŸ¥è¯†

### å¿…é¡»æŒæ¡ï¼š
- TypeScriptåŸºç¡€è¯­æ³•
- åŒºå—é“¾å’Œæ™ºèƒ½åˆçº¦åŸºæœ¬æ¦‚å¿µ
- GraphQLåŸºç¡€çŸ¥è¯†
- å‘½ä»¤è¡Œæ“ä½œ

### å»ºè®®äº†è§£ï¼š
- æ™ºèƒ½åˆçº¦äº‹ä»¶æœºåˆ¶
- æ•°æ®åº“è®¾è®¡åŸç†
- å‰ç«¯æ•°æ®æŸ¥è¯¢ä¼˜åŒ–

---

## ğŸ§  ç¬¬ä¸€æ­¥ï¼šç†è§£å­å›¾æ ¸å¿ƒæ¦‚å¿µ

### The Graph ç”Ÿæ€ç³»ç»Ÿæ¶æ„

```
ğŸ“ˆ å®Œæ•´æ•°æ®æµç¨‹å›¾ï¼š

åŒºå—é“¾ç½‘ç»œ (Sepolia)
    â”‚ æ™ºèƒ½åˆçº¦å‘å‡ºäº‹ä»¶
    â–¼
ğŸ“¡ GraphèŠ‚ç‚¹ (ç´¢å¼•å™¨)
    â”‚ ç›‘å¬å’Œæ”¶é›†äº‹ä»¶
    â”‚ æŒ‰ç…§mapping.tså¤„ç†æ•°æ®
    â”‚ å­˜å‚¨åˆ°PostgreSQL
    â–¼  
ğŸ—ƒï¸ ç´¢å¼•æ•°æ®åº“
    â”‚ ç»“æ„åŒ–å­˜å‚¨
    â”‚ æ”¯æŒå¤æ‚æŸ¥è¯¢
    â–¼
ğŸŒ GraphQL API
    â”‚ æä¾›ç»Ÿä¸€æŸ¥è¯¢æ¥å£
    â”‚ æ”¯æŒåˆ†é¡µã€æ’åºã€è¿‡æ»¤
    â–¼
ğŸ–¥ï¸ å‰ç«¯åº”ç”¨
    â”‚ Apollo ClientæŸ¥è¯¢
    â”‚ å®æ—¶æ•°æ®å±•ç¤º
    â”‚ ç”¨æˆ·äº¤äº’
```

### ä¸ºä»€ä¹ˆå­å›¾æ¯”ç›´æ¥æŸ¥è¯¢RPCæ›´å¥½ï¼Ÿ

**æ€§èƒ½å¯¹æ¯”å®ä¾‹**ï¼š

```typescript
// âŒ ä¼ ç»ŸRPCæ–¹å¼ - æŸ¥è¯¢æ‰€æœ‰çº¢åŒ…
async function getRedPacketsTraditional() {
  // 1. è·å–åˆçº¦æ‰€æœ‰äº‹ä»¶ (éœ€è¦æ‰«ææ‰€æœ‰åŒºå—)
  const events = await contract.queryFilter('PacketCreated', 0, 'latest')
  // ğŸŒ å¯èƒ½éœ€è¦å‡ åç§’ï¼Œéšç€åŒºå—å¢åŠ ä¼šè¶Šæ¥è¶Šæ…¢
  
  // 2. æ‰‹åŠ¨å¤„ç†æ¯ä¸ªäº‹ä»¶
  const packets = []
  for (const event of events) {
    // 3. å¯¹æ¯ä¸ªçº¢åŒ…æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ (Næ¬¡RPCè°ƒç”¨)
    const packetInfo = await contract.packets(event.args.packetId)
    packets.push({ ...event.args, ...packetInfo })
  }
  
  // 4. æ‰‹åŠ¨æ’åºå’Œåˆ†é¡µ
  return packets.sort((a, b) => b.creationTime - a.creationTime).slice(0, 10)
}

// âœ… å­å›¾æ–¹å¼ - åŒæ ·çš„æŸ¥è¯¢
const GET_RED_PACKETS = gql`
  query GetRedPackets($first: Int = 10, $orderBy: RedPacket_orderBy = creationTime) {
    redPackets(first: $first, orderBy: $orderBy, orderDirection: desc) {
      id
      creator
      message
      totalAmount
      balance
      totalCount
      claimedCount
      creationTime
    }
  }
`
// âš¡ é€šå¸¸åœ¨100-300mså†…å®Œæˆï¼Œæ€§èƒ½ç¨³å®š
```

### çº¢åŒ…ç³»ç»Ÿæ•°æ®éœ€æ±‚åˆ†æ

**æ ¸å¿ƒä¸šåŠ¡æŸ¥è¯¢åœºæ™¯**ï¼š

1. **é¦–é¡µçº¢åŒ…åˆ—è¡¨** ğŸ“‹
   ```graphql
   # éœ€æ±‚ï¼šæŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºæœ€æ–°çº¢åŒ…ï¼Œæ”¯æŒåˆ†é¡µ
   query RecentRedPackets {
     redPackets(first: 20, orderBy: creationTime, orderDirection: desc) {
       id, creator, message, totalAmount, claimedCount, totalCount
     }
   }
   ```

2. **ç”¨æˆ·ä¸ªäººä¸­å¿ƒ** ğŸ‘¤
   ```graphql
   # éœ€æ±‚ï¼šç”¨æˆ·åˆ›å»ºçš„çº¢åŒ… + é¢†å–è®°å½•
   query UserActivity($user: Bytes!) {
     redPackets(where: {creator: $user}) { ... }
     claims(where: {claimer: $user}) { ... }
   }
   ```

3. **çº¢åŒ…è¯¦æƒ…é¡µ** ğŸ
   ```graphql
   # éœ€æ±‚ï¼šçº¢åŒ…è¯¦æƒ… + æ‰€æœ‰é¢†å–è®°å½•
   query RedPacketDetail($id: ID!) {
     redPacket(id: $id) { ... }
     claims(where: {redPacket: $id}) { claimer, amount, timestamp }
   }
   ```

4. **ç»Ÿè®¡ä»ªè¡¨ç›˜** ğŸ“Š
   ```graphql
   # éœ€æ±‚ï¼šå¹³å°ç»Ÿè®¡æ•°æ®
   query PlatformStats {
     redPacketStats { totalPackets, totalAmount, totalClaims }
   }
   ```

---

## ğŸš€ ç¬¬äºŒæ­¥ï¼šç¯å¢ƒæ­å»ºå®æˆ˜

### 1. å®‰è£…å¼€å‘å·¥å…·

```bash
# 1. å®‰è£…Graph CLI (å…¨å±€å®‰è£…)
npm install -g @graphprotocol/graph-cli@latest

# 2. éªŒè¯å®‰è£…
graph --version
# åº”è¯¥æ˜¾ç¤ºç±»ä¼¼ï¼š@graphprotocol/graph-cli/0.61.0

# 3. å®‰è£…å¼€å‘ä¾èµ–
npm install -g typescript ts-node

# 4. æ£€æŸ¥Node.jsç‰ˆæœ¬ (éœ€è¦>=16)
node --version
```

### 2. åˆ›å»ºThe Graph Studioé¡¹ç›®

**Step 1: è®¿é—®The Graph Studio**
1. æ‰“å¼€ https://thegraph.com/studio/
2. è¿æ¥ä½ çš„é’±åŒ… (MetaMask)
3. ç‚¹å‡» "Create a Subgraph"
4. è¾“å…¥é¡¹ç›®åç§°ï¼š`red-packet-subgraph`
5. å¤åˆ¶ç”Ÿæˆçš„éƒ¨ç½²å¯†é’¥

**Step 2: åˆå§‹åŒ–æœ¬åœ°é¡¹ç›®**

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir red-packet-subgraph
cd red-packet-subgraph

# æ–¹æ³•1: ä½¿ç”¨CLIåˆå§‹åŒ– (æ¨èæ–°æ‰‹)
graph init --studio red-packet-subgraph

# æŒ‰æç¤ºå¡«å†™ä¿¡æ¯ï¼š
# Protocol: ethereum
# Subgraph slug: red-packet-subgraph  
# Directory: red-packet-subgraph
# Ethereum network: sepolia
# Contract address: 0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f
# Contract Name: RedPacketSystem

# æ–¹æ³•2: æ‰‹åŠ¨åˆ›å»º (æ›´çµæ´»)
npm init -y
npm install --save-dev @graphprotocol/graph-cli @graphprotocol/graph-ts
```

### 3. é¡¹ç›®ç»“æ„è¯¦è§£

```bash
# æŸ¥çœ‹ç”Ÿæˆçš„é¡¹ç›®ç»“æ„
tree red-packet-subgraph

# åº”è¯¥çœ‹åˆ°ï¼š
red-packet-subgraph/
â”œâ”€â”€ ğŸ“„ schema.graphql          # æ•°æ®æ¨¡å‹å®šä¹‰ (æœ€é‡è¦!)
â”œâ”€â”€ ğŸ“„ subgraph.yaml          # é…ç½®æ–‡ä»¶ (åˆçº¦åœ°å€ã€äº‹ä»¶ç­‰)
â”œâ”€â”€ ğŸ“ src/
â”‚   â””â”€â”€ ğŸ“„ red-packet-system.ts  # äº‹ä»¶å¤„ç†é€»è¾‘ (æ ¸å¿ƒä»£ç )
â”œâ”€â”€ ğŸ“ generated/             # è‡ªåŠ¨ç”Ÿæˆçš„ç±»å‹æ–‡ä»¶ (ä¸è¦æ‰‹åŠ¨ç¼–è¾‘)
â”œâ”€â”€ ğŸ“ build/                # æ„å»ºè¾“å‡º (éƒ¨ç½²æ–‡ä»¶)
â”œâ”€â”€ ğŸ“ tests/                # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ package.json          # ä¾èµ–é…ç½®
â”œâ”€â”€ ğŸ“„ tsconfig.json         # TypeScripté…ç½®
â””â”€â”€ ğŸ“„ .gitignore           # Gitå¿½ç•¥æ–‡ä»¶
```

### 4. æ ¸å¿ƒé…ç½®æ–‡ä»¶è®¾ç½®

**ä¿®æ”¹ `package.json`**:

```json
{
  "name": "red-packet-subgraph",
  "version": "0.1.0",
  "description": "High-performance subgraph for Red Packet DApp with advanced querying capabilities",
  "repository": {
    "type": "git",
    "url": "https://github.com/your-username/red-packet-dapp"
  },
  "scripts": {
    "codegen": "graph codegen",
    "build": "graph build",
    "test": "graph test",
    "deploy": "graph deploy --studio red-packet-subgraph",
    "create-local": "graph create --node http://localhost:8020/ red-packet-subgraph",
    "deploy-local": "graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 red-packet-subgraph",
    "clean": "rm -rf build/ generated/",
    "lint": "eslint . --ext .ts",
    "format": "prettier --write \"**/*.{ts,js,json,md}\""
  },
  "devDependencies": {
    "@graphprotocol/graph-cli": "^0.61.0",
    "@graphprotocol/graph-ts": "^0.31.0",
    "matchstick-as": "^0.5.0",
    "typescript": "^5.0.0",
    "prettier": "^3.0.0",
    "eslint": "^8.0.0"
  }
}
```

**éªŒè¯ç¯å¢ƒè®¾ç½®**:

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. æµ‹è¯•ä»£ç ç”Ÿæˆ
npm run codegen
# åº”è¯¥çœ‹åˆ°: âœ“ Generate types for data source template

# 3. æµ‹è¯•æ„å»º
npm run build  
# åº”è¯¥çœ‹åˆ°: âœ“ Build completed

echo "ğŸ‰ ç¯å¢ƒæ­å»ºæˆåŠŸï¼"
```

---

## ğŸ’¡ ç¬¬ä¸‰æ­¥ï¼šæ•°æ®æ¨¡å‹è®¾è®¡å®æˆ˜

### 1. é«˜çº§Schemaè®¾è®¡

**åˆ›å»º `schema.graphql`** (å®Œæ•´ç‰ˆæœ¬):

```graphql
"""
çº¢åŒ…å®ä½“ - æ ¸å¿ƒæ•°æ®æ¨¡å‹
åŒ…å«æ‰€æœ‰çº¢åŒ…çš„åŸºæœ¬ä¿¡æ¯å’Œè®¡ç®—å­—æ®µ
"""
type RedPacket @entity {
  "çº¢åŒ…å”¯ä¸€æ ‡è¯† (packetId)"
  id: ID!
  
  "åˆ›å»ºè€…åœ°å€"
  creator: Bytes!
  
  "ç¥ç¦è¯­å†…å®¹"
  message: String!
  
  "çº¢åŒ…æ€»é‡‘é¢ (wei)"
  totalAmount: BigInt!
  
  "å‰©ä½™é‡‘é¢ (wei)"  
  balance: BigInt!
  
  "æ€»ä»½æ•°"
  totalCount: BigInt!
  
  "å·²é¢†å–ä»½æ•°"
  claimedCount: BigInt!
  
  "æ˜¯å¦å‡åˆ†æ¨¡å¼"
  isEven: Boolean!
  
  "åˆ›å»ºæ—¶é—´æˆ³"
  creationTime: BigInt!
  
  "åˆ›å»ºäº¤æ˜“å“ˆå¸Œ"
  creationTxHash: Bytes!
  
  "åˆ›å»ºåŒºå—å·"
  creationBlock: BigInt!
  
  # === å…³è”å­—æ®µ ===
  "æ‰€æœ‰é¢†å–è®°å½•"
  claims: [Claim!]! @derivedFrom(field: "redPacket")
  
  # === è®¡ç®—å­—æ®µ (åœ¨mappingä¸­è®¡ç®—) ===
  "æ˜¯å¦å·²è¿‡æœŸ (24å°æ—¶)"
  isExpired: Boolean!
  
  "æ˜¯å¦å·²é¢†å®Œ"
  isFullyClaimed: Boolean!
  
  "æ˜¯å¦å¯ä»¥æå– (åˆ›å»ºè€… + å·²è¿‡æœŸ + æœ‰ä½™é¢)"
  canWithdraw: Boolean!
  
  "å¹³å‡é‡‘é¢ (wei)"
  averageAmount: BigInt!
  
  "é¢†å–è¿›åº¦ç™¾åˆ†æ¯” (0-100)"
  progressPercentage: Int!
  
  "çŠ¶æ€: ACTIVE, EXPIRED, COMPLETED"
  status: PacketStatus!
  
  # === ç»Ÿè®¡å­—æ®µ ===
  "å·²é¢†å–é‡‘é¢"
  claimedAmount: BigInt!
  
  "æœ€åæ›´æ–°æ—¶é—´"
  lastUpdateTime: BigInt!
  
  "æœ€åæ›´æ–°åŒºå—"
  lastUpdateBlock: BigInt!
}

"""
é¢†å–è®°å½•å®ä½“ - æ¯æ¬¡æŠ¢çº¢åŒ…çš„è¯¦ç»†è®°å½•
"""
type Claim @entity {
  "é¢†å–è®°å½•å”¯ä¸€æ ‡è¯† (packetId-claimer)"
  id: ID!
  
  "å…³è”çš„çº¢åŒ…"
  redPacket: RedPacket!
  
  "é¢†å–è€…åœ°å€" 
  claimer: Bytes!
  
  "é¢†å–é‡‘é¢ (wei)"
  amount: BigInt!
  
  "é¢†å–æ—¶é—´æˆ³"
  timestamp: BigInt!
  
  "äº¤æ˜“å“ˆå¸Œ"
  transactionHash: Bytes!
  
  "åŒºå—å·"
  blockNumber: BigInt!
  
  "Gasæ¶ˆè€—"
  gasUsed: BigInt!
  
  "é¢†å–é¡ºåº (ç¬¬å‡ ä¸ªé¢†å–)"
  claimOrder: Int!
}

"""
ç”¨æˆ·ç»Ÿè®¡å®ä½“ - æ¯ä¸ªç”¨æˆ·çš„æ´»åŠ¨ç»Ÿè®¡
è‡ªåŠ¨èšåˆç”¨æˆ·çš„åˆ›å»ºå’Œé¢†å–æ•°æ®
"""
type UserStats @entity {
  "ç”¨æˆ·åœ°å€"
  id: ID!
  
  # === åˆ›å»ºç»Ÿè®¡ ===
  "åˆ›å»ºçš„çº¢åŒ…æ•°é‡"
  packetsCreated: Int!
  
  "åˆ›å»ºçš„çº¢åŒ…æ€»é‡‘é¢"
  totalAmountSent: BigInt!
  
  "å¹³å‡çº¢åŒ…é‡‘é¢"
  averagePacketAmount: BigInt!
  
  # === é¢†å–ç»Ÿè®¡ ===  
  "é¢†å–çš„çº¢åŒ…æ•°é‡"
  packetsClaimed: Int!
  
  "é¢†å–çš„æ€»é‡‘é¢"
  totalAmountReceived: BigInt!
  
  "å¹³å‡é¢†å–é‡‘é¢"
  averageClaimAmount: BigInt!
  
  # === æ—¶é—´ç»Ÿè®¡ ===
  "é¦–æ¬¡æ´»åŠ¨æ—¶é—´"
  firstActivityTime: BigInt!
  
  "æœ€åæ´»åŠ¨æ—¶é—´"
  lastActivityTime: BigInt!
  
  # === æˆåŠŸç‡ç»Ÿè®¡ ===
  "å‚ä¸çš„çº¢åŒ…æ•°(å°è¯•é¢†å–)"
  packetsParticipated: Int!
  
  "æˆåŠŸç‡ (claimed/participated * 100)"
  successRate: Int!
}

"""
æ¯æ—¥ç»Ÿè®¡å®ä½“ - å¹³å°æ¯æ—¥æ´»åŠ¨æ•°æ®
ç”¨äºä»ªè¡¨ç›˜å±•ç¤ºå’Œè¶‹åŠ¿åˆ†æ
"""
type DailyStats @entity {
  "æ—¥æœŸ (YYYY-MM-DD)"
  id: ID!
  
  "å½“æ—¥åˆ›å»ºçº¢åŒ…æ•°"
  packetsCreated: Int!
  
  "å½“æ—¥é¢†å–æ¬¡æ•°"  
  claimsCount: Int!
  
  "å½“æ—¥æ´»è·ƒç”¨æˆ·æ•°"
  activeUsers: Int!
  
  "å½“æ—¥æ€»äº¤æ˜“é‡‘é¢"
  totalVolume: BigInt!
  
  "å½“æ—¥å¹³å‡çº¢åŒ…é‡‘é¢"
  averagePacketAmount: BigInt!
  
  "æ—¥æœŸæ—¶é—´æˆ³"
  date: BigInt!
}

"""
å…¨å±€ç»Ÿè®¡å®ä½“ - å¹³å°æ•´ä½“æ•°æ®
å•ä¾‹å®ä½“ï¼ŒIDå›ºå®šä¸º"global"
"""
type GlobalStats @entity {
  "å›ºå®šID: global"
  id: ID!
  
  # === æ€»ä½“ç»Ÿè®¡ ===
  "æ€»çº¢åŒ…æ•°é‡"
  totalPackets: Int!
  
  "æ€»é¢†å–æ¬¡æ•°"
  totalClaims: Int!
  
  "ç‹¬ç«‹ç”¨æˆ·æ•°"
  uniqueUsers: Int!
  
  "æ€»äº¤æ˜“é‡‘é¢"
  totalVolume: BigInt!
  
  # === å½“å‰çŠ¶æ€ ===
  "æ´»è·ƒçº¢åŒ…æ•° (æœªå®Œæˆ)"
  activePackets: Int!
  
  "æ€»å‰©ä½™é‡‘é¢"
  totalBalance: BigInt!
  
  # === æ›´æ–°ä¿¡æ¯ ===
  "æœ€åæ›´æ–°æ—¶é—´"
  lastUpdateTime: BigInt!
  
  "æœ€åå¤„ç†çš„åŒºå—"
  lastProcessedBlock: BigInt!
}

"""
èµ„é‡‘æå–è®°å½• - 24å°æ—¶åæå–æœªé¢†å–èµ„é‡‘
"""
type Withdrawal @entity {
  "æå–è®°å½•ID (packetId-txHash)"
  id: ID!
  
  "å…³è”çš„çº¢åŒ…"
  redPacket: RedPacket!
  
  "æå–è€… (çº¢åŒ…åˆ›å»ºè€…)"
  withdrawer: Bytes!
  
  "æå–é‡‘é¢"
  amount: BigInt!
  
  "æå–æ—¶é—´"
  timestamp: BigInt!
  
  "äº¤æ˜“å“ˆå¸Œ"
  transactionHash: Bytes!
  
  "åŒºå—å·"
  blockNumber: BigInt!
}

"""
çº¢åŒ…çŠ¶æ€æšä¸¾
"""
enum PacketStatus {
  "æ´»è·ƒçŠ¶æ€ - å¯ä»¥é¢†å–"
  ACTIVE
  
  "å·²è¿‡æœŸ - 24å°æ—¶åæœªé¢†å®Œ"
  EXPIRED
  
  "å·²å®Œæˆ - å…¨éƒ¨é¢†å–å®Œæ¯•"
  COMPLETED
  
  "å·²æå– - åˆ›å»ºè€…å·²æå–å‰©ä½™èµ„é‡‘"
  WITHDRAWN
}
```

### 2. æ•°æ®æ¨¡å‹è®¾è®¡åŸç†

**å…³ç³»è®¾è®¡è¯´æ˜**ï¼š

```typescript
// ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªçº¢åŒ…å¯¹åº”å¤šä¸ªé¢†å–è®°å½•
RedPacket â†1--nâ†’ Claim

// èšåˆå…³ç³»ï¼šç”¨æˆ·ç»Ÿè®¡èšåˆå¤šä¸ªçº¢åŒ…å’Œé¢†å–è®°å½•  
User â†1--nâ†’ RedPacket (created)
User â†1--nâ†’ Claim (claimed)

// æ—¶é—´åºåˆ—ï¼šæ¯æ—¥ç»Ÿè®¡æŒ‰æ—¥æœŸèšåˆ
Date â†1--1â†’ DailyStats

// å…¨å±€å•ä¾‹ï¼šæ•´ä¸ªå¹³å°çš„ç»Ÿè®¡ä¿¡æ¯
Global â†1--1â†’ GlobalStats
```

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**ï¼š

```graphql
# è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•å­—æ®µï¼š
# - æ‰€æœ‰ @entity çš„ id å­—æ®µ
# - æ‰€æœ‰å¸¦ @derivedFrom çš„å…³è”å­—æ®µ  
# - æšä¸¾ç±»å‹å­—æ®µ

# æŸ¥è¯¢ä¼˜åŒ–è€ƒè™‘ï¼š
# 1. ç»å¸¸ä½œä¸º where æ¡ä»¶çš„å­—æ®µ
# 2. éœ€è¦æ’åºçš„å­—æ®µ (creationTime)
# 3. å…³è”æŸ¥è¯¢çš„å¤–é”®å­—æ®µ
```

**å­—æ®µè®¾è®¡åŸåˆ™**ï¼š

1. **å­˜å‚¨åŸå§‹æ•°æ®** + **è®¡ç®—è¡ç”Ÿæ•°æ®**
   ```graphql
   totalAmount: BigInt!      # åŸå§‹ï¼šåˆçº¦è¿”å›çš„å€¼
   averageAmount: BigInt!    # è¡ç”Ÿï¼štotalAmount / totalCount  
   ```

2. **æ—¶é—´æˆ³ç»Ÿä¸€ä½¿ç”¨ BigInt**
   ```graphql
   creationTime: BigInt!     # ç§’çº§æ—¶é—´æˆ³ï¼Œä¾¿äºè®¡ç®—å’Œæ¯”è¾ƒ
   ```

3. **é‡‘é¢ä½¿ç”¨ BigInt ä¿æŒç²¾åº¦**
   ```graphql
   amount: BigInt!           # weiå•ä½ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
   ```

4. **çŠ¶æ€ç”¨æšä¸¾ç±»å‹**
   ```graphql
   status: PacketStatus!     # ç±»å‹å®‰å…¨ï¼Œä¾¿äºè¿‡æ»¤
   ```

---

## ğŸ”¥ ç¬¬å››æ­¥ï¼šäº‹ä»¶å¤„ç†é€»è¾‘å®æˆ˜

### 1. é…ç½®å­å›¾æ–‡ä»¶

**ä¿®æ”¹ `subgraph.yaml`**:

```yaml
specVersion: 0.0.5
schema:
  file: ./schema.graphql
dataSources:
  - kind: ethereum
    name: RedPacketSystem
    network: sepolia
    source:
      address: "0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f"
      abi: RedPacketSystem
      # èµ·å§‹åŒºå—å· - åˆçº¦éƒ¨ç½²çš„åŒºå—
      startBlock: 4680000
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - RedPacket
        - Claim  
        - UserStats
        - DailyStats
        - GlobalStats
        - Withdrawal
      abis:
        - name: RedPacketSystem
          file: ./abis/RedPacketSystem.json
      eventHandlers:
        - event: PacketCreated(indexed uint256,indexed address,string,uint256,uint256,bool)
          handler: handlePacketCreated
        - event: PacketClaimed(indexed uint256,indexed address,uint256)
          handler: handlePacketClaimed
        - event: AlreadyClaimed(indexed uint256,indexed address)
          handler: handleAlreadyClaimed
        - event: FundsWithdrawn(indexed uint256,indexed address,uint256)
          handler: handleFundsWithdrawn
      file: ./src/red-packet-system.ts
```

### 2. æ ¸å¿ƒæ˜ å°„é€»è¾‘å®ç°

**åˆ›å»º `src/red-packet-system.ts`** (å®Œæ•´ç‰ˆæœ¬):

```typescript
import { BigInt, Bytes, log, Address } from '@graphprotocol/graph-ts'
import {
  PacketCreated,
  PacketClaimed, 
  AlreadyClaimed,
  FundsWithdrawn
} from '../generated/RedPacketSystem/RedPacketSystem'
import { 
  RedPacket, 
  Claim, 
  UserStats, 
  DailyStats, 
  GlobalStats,
  Withdrawal 
} from '../generated/schema'

// ===== å·¥å…·å‡½æ•° =====

/**
 * è·å–æ—¥æœŸID (YYYY-MM-DDæ ¼å¼)
 */
function getDayId(timestamp: BigInt): string {
  // å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºå¤©æ•°
  const daysSinceEpoch = timestamp.div(BigInt.fromI32(86400))
  return daysSinceEpoch.toString()
}

/**
 * è·å–æˆ–åˆ›å»ºç”¨æˆ·ç»Ÿè®¡
 */
function getOrCreateUserStats(address: Bytes): UserStats {
  let userStats = UserStats.load(address.toHexString())
  
  if (userStats == null) {
    userStats = new UserStats(address.toHexString())
    userStats.packetsCreated = 0
    userStats.totalAmountSent = BigInt.fromI32(0)
    userStats.averagePacketAmount = BigInt.fromI32(0)
    userStats.packetsClaimed = 0
    userStats.totalAmountReceived = BigInt.fromI32(0)
    userStats.averageClaimAmount = BigInt.fromI32(0)
    userStats.firstActivityTime = BigInt.fromI32(0)
    userStats.lastActivityTime = BigInt.fromI32(0)
    userStats.packetsParticipated = 0
    userStats.successRate = 0
    
    log.info('[UserStats] åˆ›å»ºæ–°ç”¨æˆ·ç»Ÿè®¡: {}', [address.toHexString()])
  }
  
  return userStats as UserStats
}

/**
 * è·å–æˆ–åˆ›å»ºæ¯æ—¥ç»Ÿè®¡
 */
function getOrCreateDailyStats(timestamp: BigInt): DailyStats {
  const dayId = getDayId(timestamp)
  let dailyStats = DailyStats.load(dayId)
  
  if (dailyStats == null) {
    dailyStats = new DailyStats(dayId)
    dailyStats.packetsCreated = 0
    dailyStats.claimsCount = 0
    dailyStats.activeUsers = 0
    dailyStats.totalVolume = BigInt.fromI32(0)
    dailyStats.averagePacketAmount = BigInt.fromI32(0)
    dailyStats.date = timestamp
    
    log.info('[DailyStats] åˆ›å»ºæ–°æ—¥ç»Ÿè®¡: {}', [dayId])
  }
  
  return dailyStats as DailyStats
}

/**
 * è·å–æˆ–åˆ›å»ºå…¨å±€ç»Ÿè®¡
 */
function getOrCreateGlobalStats(): GlobalStats {
  let globalStats = GlobalStats.load('global')
  
  if (globalStats == null) {
    globalStats = new GlobalStats('global')
    globalStats.totalPackets = 0
    globalStats.totalClaims = 0
    globalStats.uniqueUsers = 0
    globalStats.totalVolume = BigInt.fromI32(0)
    globalStats.activePackets = 0
    globalStats.totalBalance = BigInt.fromI32(0)
    globalStats.lastUpdateTime = BigInt.fromI32(0)
    globalStats.lastProcessedBlock = BigInt.fromI32(0)
    
    log.info('[GlobalStats] åˆ›å»ºå…¨å±€ç»Ÿè®¡', [])
  }
  
  return globalStats as GlobalStats
}

/**
 * è®¡ç®—çº¢åŒ…çŠ¶æ€
 */
function calculatePacketStatus(redPacket: RedPacket, currentTime: BigInt): string {
  const TWENTY_FOUR_HOURS = BigInt.fromI32(24 * 60 * 60) // 24å°æ—¶ç§’æ•°
  
  // æ£€æŸ¥æ˜¯å¦å·²é¢†å®Œ
  if (redPacket.claimedCount >= redPacket.totalCount) {
    return 'COMPLETED'
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
  if (currentTime > redPacket.creationTime.plus(TWENTY_FOUR_HOURS)) {
    return 'EXPIRED'
  }
  
  // é»˜è®¤ä¸ºæ´»è·ƒçŠ¶æ€
  return 'ACTIVE'
}

// ===== äº‹ä»¶å¤„ç†å‡½æ•° =====

/**
 * å¤„ç†çº¢åŒ…åˆ›å»ºäº‹ä»¶
 */
export function handlePacketCreated(event: PacketCreated): void {
  log.info('[PacketCreated] å¼€å§‹å¤„ç†çº¢åŒ…åˆ›å»ºäº‹ä»¶ - ID: {}', [
    event.params.packetId.toString()
  ])

  // === 1. åˆ›å»ºçº¢åŒ…å®ä½“ ===
  const packetId = event.params.packetId.toString()
  let redPacket = new RedPacket(packetId)
  
  // åŸºæœ¬ä¿¡æ¯
  redPacket.creator = event.params.creator
  redPacket.message = event.params.message
  redPacket.totalAmount = event.params.totalAmount
  redPacket.balance = event.params.totalAmount
  redPacket.totalCount = event.params.totalCount
  redPacket.claimedCount = BigInt.fromI32(0)
  redPacket.isEven = event.params.isEven
  redPacket.creationTime = event.block.timestamp
  redPacket.creationTxHash = event.transaction.hash
  redPacket.creationBlock = event.block.number
  
  // è®¡ç®—å­—æ®µ
  redPacket.isExpired = false
  redPacket.isFullyClaimed = false
  redPacket.canWithdraw = false
  redPacket.averageAmount = event.params.totalAmount.div(event.params.totalCount)
  redPacket.progressPercentage = 0
  redPacket.status = 'ACTIVE'
  redPacket.claimedAmount = BigInt.fromI32(0)
  redPacket.lastUpdateTime = event.block.timestamp
  redPacket.lastUpdateBlock = event.block.number
  
  redPacket.save()
  log.info('[PacketCreated] çº¢åŒ…å®ä½“å·²ä¿å­˜', [])

  // === 2. æ›´æ–°åˆ›å»ºè€…ç»Ÿè®¡ ===
  let creatorStats = getOrCreateUserStats(event.params.creator)
  creatorStats.packetsCreated += 1
  creatorStats.totalAmountSent = creatorStats.totalAmountSent.plus(event.params.totalAmount)
  
  // è®¡ç®—å¹³å‡é‡‘é¢
  if (creatorStats.packetsCreated > 0) {
    creatorStats.averagePacketAmount = creatorStats.totalAmountSent
      .div(BigInt.fromI32(creatorStats.packetsCreated))
  }
  
  // æ›´æ–°æ´»åŠ¨æ—¶é—´
  if (creatorStats.firstActivityTime == BigInt.fromI32(0)) {
    creatorStats.firstActivityTime = event.block.timestamp
  }
  creatorStats.lastActivityTime = event.block.timestamp
  
  creatorStats.save()
  log.info('[PacketCreated] åˆ›å»ºè€…ç»Ÿè®¡å·²æ›´æ–°: {}', [event.params.creator.toHexString()])

  // === 3. æ›´æ–°æ¯æ—¥ç»Ÿè®¡ ===
  let dailyStats = getOrCreateDailyStats(event.block.timestamp)
  dailyStats.packetsCreated += 1
  dailyStats.totalVolume = dailyStats.totalVolume.plus(event.params.totalAmount)
  
  // è®¡ç®—å½“æ—¥å¹³å‡é‡‘é¢
  if (dailyStats.packetsCreated > 0) {
    dailyStats.averagePacketAmount = dailyStats.totalVolume
      .div(BigInt.fromI32(dailyStats.packetsCreated))
  }
  
  dailyStats.save()
  log.info('[PacketCreated] æ¯æ—¥ç»Ÿè®¡å·²æ›´æ–°', [])

  // === 4. æ›´æ–°å…¨å±€ç»Ÿè®¡ ===
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalPackets += 1
  globalStats.totalVolume = globalStats.totalVolume.plus(event.params.totalAmount)
  globalStats.activePackets += 1
  globalStats.totalBalance = globalStats.totalBalance.plus(event.params.totalAmount)
  globalStats.lastUpdateTime = event.block.timestamp
  globalStats.lastProcessedBlock = event.block.number
  
  globalStats.save()
  log.info('[PacketCreated] å…¨å±€ç»Ÿè®¡å·²æ›´æ–°', [])
  
  log.info('[PacketCreated] çº¢åŒ…åˆ›å»ºäº‹ä»¶å¤„ç†å®Œæˆ', [])
}

/**
 * å¤„ç†çº¢åŒ…é¢†å–äº‹ä»¶
 */
export function handlePacketClaimed(event: PacketClaimed): void {
  log.info('[PacketClaimed] å¼€å§‹å¤„ç†çº¢åŒ…é¢†å–äº‹ä»¶ - çº¢åŒ…ID: {}, é¢†å–è€…: {}', [
    event.params.packetId.toString(),
    event.params.claimer.toHexString()
  ])

  const packetId = event.params.packetId.toString()
  
  // === 1. åˆ›å»ºé¢†å–è®°å½• ===
  const claimId = packetId + '-' + event.params.claimer.toHexString()
  let claim = new Claim(claimId)
  
  claim.redPacket = packetId
  claim.claimer = event.params.claimer
  claim.amount = event.params.amount
  claim.timestamp = event.block.timestamp
  claim.transactionHash = event.transaction.hash
  claim.blockNumber = event.block.number
  claim.gasUsed = event.transaction.gasUsed
  
  // éœ€è¦ä»çº¢åŒ…è·å–å½“å‰é¢†å–é¡ºåº
  let redPacket = RedPacket.load(packetId)
  if (redPacket != null) {
    claim.claimOrder = redPacket.claimedCount.toI32() + 1
  } else {
    claim.claimOrder = 1
    log.error('[PacketClaimed] çº¢åŒ…ä¸å­˜åœ¨: {}', [packetId])
  }
  
  claim.save()
  log.info('[PacketClaimed] é¢†å–è®°å½•å·²ä¿å­˜', [])

  // === 2. æ›´æ–°çº¢åŒ…çŠ¶æ€ ===
  if (redPacket != null) {
    redPacket.claimedCount = redPacket.claimedCount.plus(BigInt.fromI32(1))
    redPacket.balance = redPacket.balance.minus(event.params.amount)
    redPacket.claimedAmount = redPacket.claimedAmount.plus(event.params.amount)
    
    // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
    if (redPacket.totalCount > BigInt.fromI32(0)) {
      redPacket.progressPercentage = redPacket.claimedCount
        .times(BigInt.fromI32(100))
        .div(redPacket.totalCount)
        .toI32()
    }
    
    // æ›´æ–°çŠ¶æ€æ ‡å¿—
    redPacket.isFullyClaimed = redPacket.claimedCount >= redPacket.totalCount
    redPacket.status = calculatePacketStatus(redPacket, event.block.timestamp)
    redPacket.lastUpdateTime = event.block.timestamp
    redPacket.lastUpdateBlock = event.block.number
    
    // å¦‚æœé¢†å®Œäº†ï¼Œæ›´æ–°æ´»è·ƒçº¢åŒ…æ•°
    if (redPacket.isFullyClaimed) {
      let globalStats = getOrCreateGlobalStats()
      globalStats.activePackets -= 1
      globalStats.save()
    }
    
    redPacket.save()
    log.info('[PacketClaimed] çº¢åŒ…çŠ¶æ€å·²æ›´æ–° - è¿›åº¦: {}%', [
      redPacket.progressPercentage.toString()
    ])
  }

  // === 3. æ›´æ–°é¢†å–è€…ç»Ÿè®¡ ===
  let claimerStats = getOrCreateUserStats(event.params.claimer)
  claimerStats.packetsClaimed += 1
  claimerStats.totalAmountReceived = claimerStats.totalAmountReceived.plus(event.params.amount)
  
  // è®¡ç®—å¹³å‡é¢†å–é‡‘é¢
  if (claimerStats.packetsClaimed > 0) {
    claimerStats.averageClaimAmount = claimerStats.totalAmountReceived
      .div(BigInt.fromI32(claimerStats.packetsClaimed))
  }
  
  // æ›´æ–°æ´»åŠ¨æ—¶é—´
  if (claimerStats.firstActivityTime == BigInt.fromI32(0)) {
    claimerStats.firstActivityTime = event.block.timestamp
  }
  claimerStats.lastActivityTime = event.block.timestamp
  
  claimerStats.save()
  log.info('[PacketClaimed] é¢†å–è€…ç»Ÿè®¡å·²æ›´æ–°: {}', [event.params.claimer.toHexString()])

  // === 4. æ›´æ–°æ¯æ—¥ç»Ÿè®¡ ===
  let dailyStats = getOrCreateDailyStats(event.block.timestamp)
  dailyStats.claimsCount += 1
  dailyStats.save()

  // === 5. æ›´æ–°å…¨å±€ç»Ÿè®¡ ===
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalClaims += 1
  globalStats.totalBalance = globalStats.totalBalance.minus(event.params.amount)
  globalStats.lastUpdateTime = event.block.timestamp
  globalStats.lastProcessedBlock = event.block.number
  
  globalStats.save()
  
  log.info('[PacketClaimed] çº¢åŒ…é¢†å–äº‹ä»¶å¤„ç†å®Œæˆ', [])
}

/**
 * å¤„ç†é‡å¤é¢†å–äº‹ä»¶ (è®°å½•ä½†ä¸å½±å“çŠ¶æ€)
 */
export function handleAlreadyClaimed(event: AlreadyClaimed): void {
  log.info('[AlreadyClaimed] ç”¨æˆ·é‡å¤é¢†å–çº¢åŒ… - çº¢åŒ…ID: {}, ç”¨æˆ·: {}', [
    event.params.packetId.toString(),
    event.params.claimer.toHexString()
  ])
  
  // è¿™ä¸ªäº‹ä»¶ä¸»è¦ç”¨äºå‰ç«¯å±•ç¤ºï¼Œä¸éœ€è¦åˆ›å»ºå®ä½“
  // ä½†å¯ä»¥ç”¨äºç»Ÿè®¡ç”¨æˆ·çš„å‚ä¸æ¬¡æ•°
  let userStats = getOrCreateUserStats(event.params.claimer)
  userStats.packetsParticipated += 1
  
  // é‡æ–°è®¡ç®—æˆåŠŸç‡
  if (userStats.packetsParticipated > 0) {
    userStats.successRate = (userStats.packetsClaimed * 100) / userStats.packetsParticipated
  }
  
  userStats.save()
}

/**
 * å¤„ç†èµ„é‡‘æå–äº‹ä»¶
 */
export function handleFundsWithdrawn(event: FundsWithdrawn): void {
  log.info('[FundsWithdrawn] å¼€å§‹å¤„ç†èµ„é‡‘æå–äº‹ä»¶ - çº¢åŒ…ID: {}, é‡‘é¢: {}', [
    event.params.packetId.toString(),
    event.params.amount.toString()
  ])

  const packetId = event.params.packetId.toString()
  
  // === 1. åˆ›å»ºæå–è®°å½• ===
  const withdrawalId = packetId + '-' + event.transaction.hash.toHexString()
  let withdrawal = new Withdrawal(withdrawalId)
  
  withdrawal.redPacket = packetId
  withdrawal.withdrawer = event.params.owner
  withdrawal.amount = event.params.amount
  withdrawal.timestamp = event.block.timestamp
  withdrawal.transactionHash = event.transaction.hash
  withdrawal.blockNumber = event.block.number
  
  withdrawal.save()
  log.info('[FundsWithdrawn] æå–è®°å½•å·²ä¿å­˜', [])

  // === 2. æ›´æ–°çº¢åŒ…çŠ¶æ€ ===
  let redPacket = RedPacket.load(packetId)
  if (redPacket != null) {
    redPacket.balance = BigInt.fromI32(0) // æå–åä½™é¢ä¸º0
    redPacket.status = 'WITHDRAWN'
    redPacket.lastUpdateTime = event.block.timestamp
    redPacket.lastUpdateBlock = event.block.number
    
    redPacket.save()
    log.info('[FundsWithdrawn] çº¢åŒ…çŠ¶æ€å·²æ›´æ–°ä¸ºWITHDRAWN', [])
  }

  // === 3. æ›´æ–°å…¨å±€ç»Ÿè®¡ ===
  let globalStats = getOrCreateGlobalStats()
  globalStats.activePackets -= 1 // å‡å°‘æ´»è·ƒçº¢åŒ…æ•°
  globalStats.totalBalance = globalStats.totalBalance.minus(event.params.amount)
  globalStats.lastUpdateTime = event.block.timestamp
  globalStats.lastProcessedBlock = event.block.number
  
  globalStats.save()
  
  log.info('[FundsWithdrawn] èµ„é‡‘æå–äº‹ä»¶å¤„ç†å®Œæˆ', [])
}
```

### 3. é«˜çº§æ˜ å°„æŠ€å·§

**å¤„ç†å¤æ‚è®¡ç®—**ï¼š

```typescript
// è®¡ç®—æ—¶é—´ç›¸å…³å­—æ®µ
function updateTimeBasedFields(entity: RedPacket, currentTime: BigInt): void {
  const TWENTY_FOUR_HOURS = BigInt.fromI32(24 * 60 * 60)
  const timeSinceCreation = currentTime.minus(entity.creationTime)
  
  entity.isExpired = timeSinceCreation >= TWENTY_FOUR_HOURS
  entity.canWithdraw = entity.isExpired && 
                      entity.balance > BigInt.fromI32(0) &&
                      !entity.isFullyClaimed
}

// æ‰¹é‡æ›´æ–°ç›¸å…³å®ä½“
function updateRelatedEntities(packetId: string): void {
  // æ›´æ–°æ‰€æœ‰ç›¸å…³çš„èšåˆç»Ÿè®¡
  // è¿™ç§æ¨¡å¼ç”¨äºå¤æ‚çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
}
```

**é”™è¯¯å¤„ç†å’Œæ—¥å¿—**ï¼š

```typescript
export function handlePacketCreated(event: PacketCreated): void {
  try {
    // æ ¸å¿ƒé€»è¾‘
    let redPacket = new RedPacket(event.params.packetId.toString())
    // ...å¤„ç†é€»è¾‘
    
    log.info('[PacketCreated] å¤„ç†æˆåŠŸ - ID: {}', [
      event.params.packetId.toString()
    ])
  } catch (error) {
    log.error('[PacketCreated] å¤„ç†å¤±è´¥: {} - é”™è¯¯: {}', [
      event.params.packetId.toString(),
      error.message
    ])
    // å¯ä»¥é€‰æ‹©åˆ›å»ºä¸€ä¸ªé”™è¯¯è®°å½•å®ä½“
  }
}
```

---

## ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•ä¸éƒ¨ç½²å®æˆ˜

### 1. æœ¬åœ°æµ‹è¯•

**è¿è¡Œä»£ç ç”Ÿæˆå’Œæ„å»º**:

```bash
# 1. æ¸…ç†æ—§æ–‡ä»¶
npm run clean

# 2. ç”Ÿæˆç±»å‹æ–‡ä»¶
npm run codegen
# æ£€æŸ¥ generated/ ç›®å½•æ˜¯å¦ç”Ÿæˆäº†ç±»å‹æ–‡ä»¶

# 3. æ„å»ºå­å›¾
npm run build
# æ£€æŸ¥ build/ ç›®å½•æ˜¯å¦ç”Ÿæˆäº†éƒ¨ç½²æ–‡ä»¶

# 4. è¿è¡Œæµ‹è¯• (å¦‚æœæœ‰)
npm run test
```

### 2. éƒ¨ç½²åˆ°Graph Studio

```bash
# 1. è®¤è¯åˆ°Graph Studio (ä½¿ç”¨ä½ çš„éƒ¨ç½²å¯†é’¥)
graph auth --studio YOUR_DEPLOY_KEY

# 2. éƒ¨ç½²å­å›¾
npm run deploy

# ç­‰å¾…éƒ¨ç½²å®Œæˆ...
# âœ… éƒ¨ç½²æˆåŠŸåä¼šå¾—åˆ°æŸ¥è¯¢ç«¯ç‚¹
```

### 3. éªŒè¯éƒ¨ç½²

**æµ‹è¯•GraphQLæŸ¥è¯¢**:

```graphql
# åœ¨Graph Studio playgroundä¸­æµ‹è¯•
query TestBasicQuery {
  redPackets(first: 5, orderBy: creationTime, orderDirection: desc) {
    id
    creator
    message
    totalAmount
    balance
    status
    creationTime
  }
}

query TestUserStats {
  userStats(first: 10, orderBy: packetsCreated, orderDirection: desc) {
    id
    packetsCreated
    totalAmountSent
    packetsClaimed
    totalAmountReceived
  }
}

query TestGlobalStats {
  globalStats(id: "global") {
    totalPackets
    totalClaims
    totalVolume
    activePackets
  }
}
```

**æ€§èƒ½ç›‘æ§æŸ¥è¯¢**:

```graphql
query PerformanceTest {
  # æµ‹è¯•å¤æ‚å…³è”æŸ¥è¯¢
  redPackets(first: 10) {
    id
    creator
    message
    claims(first: 5) {
      claimer
      amount
      timestamp
    }
  }
}
```

---

## ğŸš€ ç¬¬å…­æ­¥ï¼šå‰ç«¯é›†æˆå®æˆ˜

### å‰ç«¯GraphQLæŸ¥è¯¢ç¤ºä¾‹

```typescript
// 1. çº¢åŒ…åˆ—è¡¨æŸ¥è¯¢
export const GET_RED_PACKETS = gql`
  query GetRedPackets(
    $first: Int = 20
    $skip: Int = 0
    $orderBy: RedPacket_orderBy = creationTime
    $orderDirection: OrderDirection = desc
    $where: RedPacket_filter
  ) {
    redPackets(
      first: $first
      skip: $skip
      orderBy: $orderBy
      orderDirection: $orderDirection
      where: $where
    ) {
      id
      creator
      message
      totalAmount
      balance
      totalCount
      claimedCount
      isEven
      status
      progressPercentage
      creationTime
      isExpired
      canWithdraw
    }
  }
`

// 2. ç”¨æˆ·æ´»åŠ¨æŸ¥è¯¢
export const GET_USER_ACTIVITY = gql`
  query GetUserActivity($user: Bytes!) {
    # ç”¨æˆ·åˆ›å»ºçš„çº¢åŒ…
    createdPackets: redPackets(
      where: { creator: $user }
      orderBy: creationTime
      orderDirection: desc
    ) {
      id
      message
      totalAmount
      claimedCount
      totalCount
      status
      creationTime
    }
    
    # ç”¨æˆ·çš„é¢†å–è®°å½•
    claims(
      where: { claimer: $user }
      orderBy: timestamp
      orderDirection: desc
    ) {
      id
      redPacket {
        id
        creator
        message
      }
      amount
      timestamp
    }
    
    # ç”¨æˆ·ç»Ÿè®¡
    userStats(id: $user) {
      packetsCreated
      totalAmountSent
      packetsClaimed  
      totalAmountReceived
      successRate
    }
  }
`

// 3. å¹³å°ç»Ÿè®¡æŸ¥è¯¢
export const GET_PLATFORM_STATS = gql`
  query GetPlatformStats {
    globalStats(id: "global") {
      totalPackets
      totalClaims
      uniqueUsers
      totalVolume
      activePackets
      totalBalance
    }
    
    # æœ€è¿‘7å¤©çš„æ•°æ®
    recentDailyStats: dailyStats(
      first: 7
      orderBy: date
      orderDirection: desc
    ) {
      id
      packetsCreated
      claimsCount
      activeUsers
      totalVolume
      date
    }
  }
`
```

## ğŸ“š çŸ¥è¯†æ€»ç»“

### ä½ å·²ç»æŒæ¡çš„æ ¸å¿ƒæŠ€èƒ½

1. **å­å›¾æ¶æ„è®¾è®¡**:
   - å¤æ‚æ•°æ®æ¨¡å‹è®¾è®¡
   - å®ä½“å…³ç³»å’Œç´¢å¼•ä¼˜åŒ–
   - èšåˆç»Ÿè®¡å’Œè®¡ç®—å­—æ®µ

2. **é«˜æ•ˆäº‹ä»¶å¤„ç†**:
   - AssemblyScriptç¼–ç¨‹
   - äº‹ä»¶ç›‘å¬å’Œæ•°æ®è½¬æ¢
   - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

3. **æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:
   - æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
   - æ•°æ®é¢„è®¡ç®—
   - æ‰¹é‡æ“ä½œå¤„ç†

4. **éƒ¨ç½²å’Œç»´æŠ¤**:
   - Graph Studioé›†æˆ
   - ç‰ˆæœ¬ç®¡ç†å’Œæ›´æ–°
   - ç›‘æ§å’Œæ•…éšœæ’é™¤

**æ­å–œï¼ä½ å·²ç»å®Œæˆäº†é«˜æ€§èƒ½å­å›¾å¼€å‘çš„å®Œæ•´å­¦ä¹ ï¼** ğŸ‰

ç°åœ¨ä½ å¯ä»¥ï¼š
- è®¾è®¡å¤æ‚çš„æ•°æ®æ¨¡å‹å’Œå…³ç³»
- ç¼–å†™é«˜æ•ˆçš„äº‹ä»¶å¤„ç†é€»è¾‘  
- éƒ¨ç½²å’Œç»´æŠ¤ç”Ÿäº§çº§å­å›¾
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

ç»§ç»­å®è·µï¼Œæˆä¸º The Graph å¼€å‘ä¸“å®¶ï¼ ğŸš€

```bash
# å…¨å±€å®‰è£… Graph CLI
npm install -g @graphprotocol/graph-cli

# éªŒè¯å®‰è£…
graph --version
```

### 2. åˆå§‹åŒ– Subgraph é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir red-packet-subgraph
cd red-packet-subgraph

# åˆå§‹åŒ– subgraph
graph init \
  --studio \
  red-packet-subgraph \
  --from-contract 0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f \
  --network sepolia \
  --contract-name RedPacketSystem

# æˆ–è€…ä»ç°æœ‰ç›®å½•åˆå§‹åŒ–
graph init --from-contract 0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f --network sepolia
```

### 3. é¡¹ç›®ç»“æ„è§£æ

```
red-packet-subgraph/
â”œâ”€â”€ schema.graphql         # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ subgraph.yaml         # å­å›¾é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â””â”€â”€ mapping.ts        # äº‹ä»¶å¤„ç†é€»è¾‘
â”œâ”€â”€ generated/            # è‡ªåŠ¨ç”Ÿæˆçš„ç±»å‹æ–‡ä»¶
â”œâ”€â”€ build/               # æ„å»ºè¾“å‡º
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### 4. æ ¸å¿ƒé…ç½®æ–‡ä»¶

**package.json**:
```json
{
  "name": "red-packet-subgraph",
  "version": "0.1.0",
  "description": "Subgraph for Red Packet DApp",
  "scripts": {
    "codegen": "graph codegen",
    "build": "graph build",
    "deploy": "graph deploy --studio red-packet-subgraph",
    "create-local": "graph create --node http://localhost:8020/ red-packet-subgraph",
    "remove-local": "graph remove --node http://localhost:8020/ red-packet-subgraph",
    "deploy-local": "graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 red-packet-subgraph",
    "test": "graph test"
  },
  "dependencies": {
    "@graphprotocol/graph-cli": "^0.69.0",
    "@graphprotocol/graph-ts": "^0.34.0"
  }
}
```

## ğŸ’¡ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. GraphQL Schema è®¾è®¡

**schema.graphql**:
```graphql
# çº¢åŒ…å®ä½“
type RedPacket @entity {
  id: ID!                           # çº¢åŒ…ID
  creator: Bytes!                   # åˆ›å»ºè€…åœ°å€
  message: String!                  # ç¥ç¦è¯­
  totalAmount: BigInt!              # æ€»é‡‘é¢ï¼ˆweiï¼‰
  balance: BigInt!                  # å‰©ä½™é‡‘é¢ï¼ˆweiï¼‰  
  totalCount: Int!                  # æ€»ä»½æ•°
  claimedCount: Int!                # å·²é¢†å–ä»½æ•°
  isEven: Boolean!                  # æ˜¯å¦å‡åˆ†æ¨¡å¼
  creationTime: BigInt!             # åˆ›å»ºæ—¶é—´æˆ³
  blockNumber: BigInt!              # åˆ›å»ºåŒºå—å·
  transactionHash: Bytes!           # äº¤æ˜“å“ˆå¸Œ
  
  # å…³è”å…³ç³»
  claims: [Claim!]! @derivedFrom(field: "redPacket")  # æ‰€æœ‰é¢†å–è®°å½•
  
  # è®¡ç®—å­—æ®µï¼ˆåœ¨mappingä¸­è®¡ç®—ï¼‰
  isActive: Boolean!                # æ˜¯å¦ä»å¯é¢†å–
  averageAmount: BigInt!            # å¹³å‡é‡‘é¢
  completionRate: BigDecimal!       # å®Œæˆç‡ (0-1)
}

# é¢†å–è®°å½•å®ä½“
type Claim @entity {
  id: ID!                          # é¢†å–è®°å½•ID (packetId-claimer)
  redPacket: RedPacket!            # å…³è”çš„çº¢åŒ…
  claimer: Bytes!                  # é¢†å–è€…åœ°å€
  amount: BigInt!                  # é¢†å–é‡‘é¢ï¼ˆweiï¼‰
  timestamp: BigInt!               # é¢†å–æ—¶é—´æˆ³
  blockNumber: BigInt!             # é¢†å–åŒºå—å·
  transactionHash: Bytes!          # äº¤æ˜“å“ˆå¸Œ
  claimIndex: Int!                 # é¢†å–åºå·ï¼ˆç¬¬å‡ ä¸ªé¢†å–ï¼‰
}

# ç”¨æˆ·ç»Ÿè®¡å®ä½“
type User @entity {
  id: ID!                          # ç”¨æˆ·åœ°å€
  address: Bytes!                  # ç”¨æˆ·åœ°å€
  
  # åˆ›å»ºç»Ÿè®¡
  createdPacketsCount: Int!        # åˆ›å»ºçº¢åŒ…æ•°é‡
  totalAmountCreated: BigInt!      # åˆ›å»ºçº¢åŒ…æ€»é‡‘é¢
  createdPackets: [RedPacket!]! @derivedFrom(field: "creator")
  
  # é¢†å–ç»Ÿè®¡
  claimedPacketsCount: Int!        # é¢†å–çº¢åŒ…æ•°é‡
  totalAmountClaimed: BigInt!      # é¢†å–çº¢åŒ…æ€»é‡‘é¢
  claims: [Claim!]! @derivedFrom(field: "claimer")
  
  # æ—¶é—´ç»Ÿè®¡
  firstActivity: BigInt!           # é¦–æ¬¡æ´»åŠ¨æ—¶é—´
  lastActivity: BigInt!            # æœ€åæ´»åŠ¨æ—¶é—´
}

# å…¨å±€ç»Ÿè®¡å®ä½“
type GlobalStats @entity {
  id: ID!                          # å›ºå®šä¸º "global"
  totalPackets: Int!               # æ€»çº¢åŒ…æ•°é‡
  totalAmount: BigInt!             # æ€»é‡‘é¢
  totalClaims: Int!                # æ€»é¢†å–æ¬¡æ•°
  activePackets: Int!              # æ´»è·ƒçº¢åŒ…æ•°é‡
  totalUsers: Int!                 # æ€»ç”¨æˆ·æ•°
  lastUpdated: BigInt!             # æœ€åæ›´æ–°æ—¶é—´
}

# æ¯æ—¥ç»Ÿè®¡å®ä½“
type DayStats @entity {
  id: ID!                          # æ ¼å¼: "YYYY-MM-DD"
  date: Int!                       # æ—¥æœŸæˆ³
  packetsCreated: Int!             # å½“æ—¥åˆ›å»ºçº¢åŒ…æ•°
  packetsClaimed: Int!             # å½“æ—¥é¢†å–çº¢åŒ…æ•°  
  amountCreated: BigInt!           # å½“æ—¥åˆ›å»ºé‡‘é¢
  amountClaimed: BigInt!           # å½“æ—¥é¢†å–é‡‘é¢
  activeUsers: Int!                # å½“æ—¥æ´»è·ƒç”¨æˆ·æ•°
}
```

### 2. æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™

1. **å®ä½“å…³ç³»è®¾è®¡**
   - `RedPacket` â†” `Claim`: ä¸€å¯¹å¤šå…³ç³»
   - `User` â†” `RedPacket`: ä¸€å¯¹å¤šå…³ç³»ï¼ˆåˆ›å»ºè€…ï¼‰
   - `User` â†” `Claim`: ä¸€å¯¹å¤šå…³ç³»ï¼ˆé¢†å–è€…ï¼‰

2. **ç´¢å¼•ä¼˜åŒ–**
   - ç»å¸¸æŸ¥è¯¢çš„å­—æ®µè®¾ä¸ºç´¢å¼•
   - æ—¶é—´å­—æ®µç”¨äºæ’åºå’Œè¿‡æ»¤
   - å…³è”å­—æ®µæå‡æŸ¥è¯¢æ€§èƒ½

3. **è®¡ç®—å­—æ®µ**
   - å®æ—¶è®¡ç®—çš„çŠ¶æ€å­—æ®µ
   - èšåˆç»Ÿè®¡æ•°æ®
   - ä¾¿äºå‰ç«¯ç›´æ¥ä½¿ç”¨

## ğŸ”§ äº‹ä»¶å¤„ç†é€»è¾‘å®ç°

### 1. Subgraph é…ç½®

**subgraph.yaml**:
```yaml
specVersion: 1.0.0
indexerHints:
  prune: auto
schema:
  file: ./schema.graphql
dataSources:
  - kind: ethereum
    name: RedPacketSystem
    network: sepolia
    source:
      address: "0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f"
      abi: RedPacketSystem
      startBlock: 4800000  # åˆçº¦éƒ¨ç½²çš„åŒºå—å·
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - RedPacket
        - Claim
        - User
        - GlobalStats
        - DayStats
      abis:
        - name: RedPacketSystem
          file: ./abis/RedPacketSystem.json
      eventHandlers:
        - event: PacketCreated(indexed uint256,indexed address,string,uint256,uint256,bool)
          handler: handlePacketCreated
        - event: PacketClaimed(indexed uint256,indexed address,uint256)
          handler: handlePacketClaimed
        - event: PacketEmpty(indexed uint256)
          handler: handlePacketEmpty
        - event: FundsWithdrawn(indexed uint256,indexed address,uint256)
          handler: handleFundsWithdrawn
      file: ./src/mapping.ts
```

### 2. æ˜ å°„é€»è¾‘å®ç°

**src/mapping.ts**:
```typescript
import {
  PacketCreated,
  PacketClaimed,
  PacketEmpty,
  FundsWithdrawn
} from "../generated/RedPacketSystem/RedPacketSystem"

import {
  RedPacket,
  Claim,
  User,
  GlobalStats,
  DayStats
} from "../generated/schema"

import {
  BigInt,
  BigDecimal,
  Address,
  Bytes
} from "@graphprotocol/graph-ts"

// å¸¸é‡å®šä¹‰
const GLOBAL_STATS_ID = "global"
const ZERO_BI = BigInt.fromI32(0)
const ONE_BI = BigInt.fromI32(1)

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºç”¨æˆ·å®ä½“
function getOrCreateUser(address: Address): User {
  let user = User.load(address.toHex())
  
  if (user === null) {
    user = new User(address.toHex())
    user.address = address
    user.createdPacketsCount = 0
    user.totalAmountCreated = ZERO_BI
    user.claimedPacketsCount = 0
    user.totalAmountClaimed = ZERO_BI
    user.firstActivity = ZERO_BI
    user.lastActivity = ZERO_BI
    user.save()
    
    // æ›´æ–°å…¨å±€ç”¨æˆ·ç»Ÿè®¡
    updateGlobalUserCount()
  }
  
  return user
}

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºå…¨å±€ç»Ÿè®¡
function getOrCreateGlobalStats(): GlobalStats {
  let stats = GlobalStats.load(GLOBAL_STATS_ID)
  
  if (stats === null) {
    stats = new GlobalStats(GLOBAL_STATS_ID)
    stats.totalPackets = 0
    stats.totalAmount = ZERO_BI
    stats.totalClaims = 0
    stats.activePackets = 0
    stats.totalUsers = 0
    stats.lastUpdated = ZERO_BI
  }
  
  return stats
}

// å·¥å…·å‡½æ•°ï¼šè·å–æ¯æ—¥ç»Ÿè®¡ID
function getDayStatsId(timestamp: BigInt): string {
  const date = new Date(timestamp.toI32() * 1000)
  const year = date.getUTCFullYear()
  const month = date.getUTCMonth() + 1
  const day = date.getUTCDate()
  
  const monthStr = month < 10 ? "0" + month.toString() : month.toString()
  const dayStr = day < 10 ? "0" + day.toString() : day.toString()
  
  return year.toString() + "-" + monthStr + "-" + dayStr
}

// å·¥å…·å‡½æ•°ï¼šè·å–æˆ–åˆ›å»ºæ¯æ—¥ç»Ÿè®¡
function getOrCreateDayStats(timestamp: BigInt): DayStats {
  const dayStatsId = getDayStatsId(timestamp)
  let dayStats = DayStats.load(dayStatsId)
  
  if (dayStats === null) {
    dayStats = new DayStats(dayStatsId)
    const date = new Date(timestamp.toI32() * 1000)
    dayStats.date = BigInt.fromI32(Math.floor(date.getTime() / 1000 / 86400) * 86400)
    dayStats.packetsCreated = 0
    dayStats.packetsClaimed = 0
    dayStats.amountCreated = ZERO_BI
    dayStats.amountClaimed = ZERO_BI
    dayStats.activeUsers = 0
  }
  
  return dayStats
}

// å·¥å…·å‡½æ•°ï¼šæ›´æ–°å…¨å±€ç”¨æˆ·æ•°é‡
function updateGlobalUserCount(): void {
  let stats = getOrCreateGlobalStats()
  stats.totalUsers = stats.totalUsers + 1
  stats.save()
}

// å·¥å…·å‡½æ•°ï¼šè®¡ç®—å®Œæˆç‡
function calculateCompletionRate(claimedCount: i32, totalCount: i32): BigDecimal {
  if (totalCount === 0) {
    return BigDecimal.fromString("0")
  }
  return BigDecimal.fromString(claimedCount.toString()).div(BigDecimal.fromString(totalCount.toString()))
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…åˆ›å»º
export function handlePacketCreated(event: PacketCreated): void {
  // åˆ›å»ºçº¢åŒ…å®ä½“
  let redPacket = new RedPacket(event.params.packetId.toString())
  
  redPacket.creator = event.params.creator
  redPacket.message = event.params.message
  redPacket.totalAmount = event.params.totalAmount
  redPacket.balance = event.params.totalAmount  // åˆå§‹ä½™é¢ç­‰äºæ€»é‡‘é¢
  redPacket.totalCount = event.params.totalCount.toI32()
  redPacket.claimedCount = 0
  redPacket.isEven = event.params.isEven
  redPacket.creationTime = event.block.timestamp
  redPacket.blockNumber = event.block.number
  redPacket.transactionHash = event.transaction.hash
  
  // è®¡ç®—å­—æ®µ
  redPacket.isActive = true
  redPacket.averageAmount = event.params.totalAmount.div(BigInt.fromI32(event.params.totalCount.toI32()))
  redPacket.completionRate = BigDecimal.fromString("0")
  
  redPacket.save()

  // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
  let creator = getOrCreateUser(event.params.creator)
  creator.createdPacketsCount = creator.createdPacketsCount + 1
  creator.totalAmountCreated = creator.totalAmountCreated.plus(event.params.totalAmount)
  
  if (creator.firstActivity.equals(ZERO_BI)) {
    creator.firstActivity = event.block.timestamp
  }
  creator.lastActivity = event.block.timestamp
  creator.save()

  // æ›´æ–°å…¨å±€ç»Ÿè®¡
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalPackets = globalStats.totalPackets + 1
  globalStats.totalAmount = globalStats.totalAmount.plus(event.params.totalAmount)
  globalStats.activePackets = globalStats.activePackets + 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()

  // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
  let dayStats = getOrCreateDayStats(event.block.timestamp)
  dayStats.packetsCreated = dayStats.packetsCreated + 1
  dayStats.amountCreated = dayStats.amountCreated.plus(event.params.totalAmount)
  dayStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…é¢†å–
export function handlePacketClaimed(event: PacketClaimed): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    // è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§
    return
  }

  // åˆ›å»ºé¢†å–è®°å½•
  let claimId = event.params.packetId.toString() + "-" + event.params.claimer.toHex()
  let claim = new Claim(claimId)
  
  claim.redPacket = redPacket.id
  claim.claimer = event.params.claimer
  claim.amount = event.params.amount
  claim.timestamp = event.block.timestamp
  claim.blockNumber = event.block.number
  claim.transactionHash = event.transaction.hash
  claim.claimIndex = redPacket.claimedCount + 1  // é¢†å–åºå·
  
  claim.save()

  // æ›´æ–°çº¢åŒ…çŠ¶æ€
  redPacket.claimedCount = redPacket.claimedCount + 1
  redPacket.balance = redPacket.balance.minus(event.params.amount)
  redPacket.completionRate = calculateCompletionRate(redPacket.claimedCount, redPacket.totalCount)
  
  // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½é¢†å–
  if (redPacket.claimedCount >= redPacket.totalCount) {
    redPacket.isActive = false
  }
  
  redPacket.save()

  // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
  let claimer = getOrCreateUser(event.params.claimer)
  claimer.claimedPacketsCount = claimer.claimedPacketsCount + 1
  claimer.totalAmountClaimed = claimer.totalAmountClaimed.plus(event.params.amount)
  
  if (claimer.firstActivity.equals(ZERO_BI)) {
    claimer.firstActivity = event.block.timestamp
  }
  claimer.lastActivity = event.block.timestamp
  claimer.save()

  // æ›´æ–°å…¨å±€ç»Ÿè®¡
  let globalStats = getOrCreateGlobalStats()
  globalStats.totalClaims = globalStats.totalClaims + 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()

  // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
  let dayStats = getOrCreateDayStats(event.block.timestamp)
  dayStats.packetsClaimed = dayStats.packetsClaimed + 1
  dayStats.amountClaimed = dayStats.amountClaimed.plus(event.params.amount)
  dayStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šçº¢åŒ…æŠ¢å®Œ
export function handlePacketEmpty(event: PacketEmpty): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    return
  }

  // ç¡®ä¿çº¢åŒ…çŠ¶æ€æ­£ç¡®
  redPacket.isActive = false
  redPacket.completionRate = BigDecimal.fromString("1")
  redPacket.save()

  // æ›´æ–°å…¨å±€æ´»è·ƒçº¢åŒ…æ•°é‡
  let globalStats = getOrCreateGlobalStats()
  globalStats.activePackets = globalStats.activePackets - 1
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()
}

// äº‹ä»¶å¤„ç†å™¨ï¼šèµ„é‡‘æå–
export function handleFundsWithdrawn(event: FundsWithdrawn): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    return
  }

  // æ›´æ–°çº¢åŒ…çŠ¶æ€
  redPacket.balance = ZERO_BI
  redPacket.isActive = false
  redPacket.save()

  // æ›´æ–°å…¨å±€æ´»è·ƒçº¢åŒ…æ•°é‡
  let globalStats = getOrCreateGlobalStats()
  if (redPacket.isActive) {
    globalStats.activePackets = globalStats.activePackets - 1
  }
  globalStats.lastUpdated = event.block.timestamp
  globalStats.save()
}
```

### 3. é«˜çº§æŸ¥è¯¢ä¼˜åŒ–

ä¸ºäº†æä¾›æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ˜ å°„ä¸­æ·»åŠ ä¸€äº›ç´¢å¼•å­—æ®µï¼š

```typescript
// åœ¨ handlePacketCreated ä¸­æ·»åŠ 
redPacket.creatorLowerCase = event.params.creator.toHex().toLowerCase()  // ä¾¿äºæœç´¢
redPacket.dayCreated = getDayStatsId(event.block.timestamp)              // ä¾¿äºæŒ‰å¤©è¿‡æ»¤

// åœ¨ handlePacketClaimed ä¸­æ·»åŠ   
claim.claimerLowerCase = event.params.claimer.toHex().toLowerCase()      // ä¾¿äºæœç´¢
claim.dayCreated = getDayStatsId(event.block.timestamp)                  // ä¾¿äºæŒ‰å¤©è¿‡æ»¤
```

## ğŸ§ª æµ‹è¯•ä¸è°ƒè¯•

### 1. æœ¬åœ°æµ‹è¯•ç¯å¢ƒæ­å»º

**å®‰è£… Matchstick æµ‹è¯•æ¡†æ¶**:
```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
npm install --save-dev matchstick-as

# åˆ›å»ºæµ‹è¯•ç›®å½•
mkdir tests
```

**tests/red-packet-system.test.ts**:
```typescript
import {
  test,
  assert,
  describe,
  beforeEach,
  clearStore,
  createMockedFunction,
  newMockEvent
} from "matchstick-as/assembly/index"

import { 
  handlePacketCreated,
  handlePacketClaimed 
} from "../src/mapping"

import { PacketCreated, PacketClaimed } from "../generated/RedPacketSystem/RedPacketSystem"
import { RedPacket, Claim } from "../generated/schema"
import { BigInt, Address, ethereum } from "@graphprotocol/graph-ts"

// æµ‹è¯•å·¥å…·å‡½æ•°
function createPacketCreatedEvent(
  packetId: BigInt,
  creator: Address,
  message: string,
  totalAmount: BigInt,
  totalCount: BigInt,
  isEven: boolean
): PacketCreated {
  let event = changetype<PacketCreated>(newMockEvent())
  
  event.parameters = []
  
  event.parameters.push(
    new ethereum.EventParam("packetId", ethereum.Value.fromUnsignedBigInt(packetId))
  )
  event.parameters.push(
    new ethereum.EventParam("creator", ethereum.Value.fromAddress(creator))
  )
  event.parameters.push(
    new ethereum.EventParam("message", ethereum.Value.fromString(message))
  )
  event.parameters.push(
    new ethereum.EventParam("totalAmount", ethereum.Value.fromUnsignedBigInt(totalAmount))
  )
  event.parameters.push(
    new ethereum.EventParam("totalCount", ethereum.Value.fromUnsignedBigInt(totalCount))
  )
  event.parameters.push(
    new ethereum.EventParam("isEven", ethereum.Value.fromBoolean(isEven))
  )

  return event
}

function createPacketClaimedEvent(
  packetId: BigInt,
  claimer: Address,
  amount: BigInt
): PacketClaimed {
  let event = changetype<PacketClaimed>(newMockEvent())
  
  event.parameters = []
  
  event.parameters.push(
    new ethereum.EventParam("packetId", ethereum.Value.fromUnsignedBigInt(packetId))
  )
  event.parameters.push(
    new ethereum.EventParam("claimer", ethereum.Value.fromAddress(claimer))
  )
  event.parameters.push(
    new ethereum.EventParam("amount", ethereum.Value.fromUnsignedBigInt(amount))
  )

  return event
}

// æµ‹è¯•ç”¨ä¾‹
describe("Red Packet System", () => {
  beforeEach(() => {
    clearStore() // æ¸…ç†æµ‹è¯•å­˜å‚¨
  })

  test("Should create red packet correctly", () => {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let message = "Happy New Year!"
    let totalAmount = BigInt.fromString("1000000000000000000") // 1 ETH
    let totalCount = BigInt.fromI32(5)
    let isEven = true

    // åˆ›å»ºå¹¶å¤„ç†äº‹ä»¶
    let event = createPacketCreatedEvent(packetId, creator, message, totalAmount, totalCount, isEven)
    handlePacketCreated(event)

    // éªŒè¯çº¢åŒ…å®ä½“
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.bytesEquals(redPacket.creator, creator)
      assert.stringEquals(redPacket.message, message)
      assert.bigIntEquals(redPacket.totalAmount, totalAmount)
      assert.bigIntEquals(redPacket.balance, totalAmount)
      assert.i32Equals(redPacket.totalCount, 5)
      assert.i32Equals(redPacket.claimedCount, 0)
      assert.booleanEquals(redPacket.isEven, true)
      assert.booleanEquals(redPacket.isActive, true)
    }
  })

  test("Should handle red packet claim correctly", () => {
    // å…ˆåˆ›å»ºçº¢åŒ…
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let claimer = Address.fromString("0x0987654321098765432109876543210987654321")
    
    let createEvent = createPacketCreatedEvent(
      packetId,
      creator,
      "Test packet",
      BigInt.fromString("1000000000000000000"),
      BigInt.fromI32(2),
      false
    )
    handlePacketCreated(createEvent)

    // ç„¶åå¤„ç†é¢†å–äº‹ä»¶
    let claimAmount = BigInt.fromString("600000000000000000") // 0.6 ETH
    let claimEvent = createPacketClaimedEvent(packetId, claimer, claimAmount)
    handlePacketClaimed(claimEvent)

    // éªŒè¯çº¢åŒ…çŠ¶æ€æ›´æ–°
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.i32Equals(redPacket.claimedCount, 1)
      assert.bigIntEquals(redPacket.balance, BigInt.fromString("400000000000000000"))
      assert.booleanEquals(redPacket.isActive, true) // è¿˜æœ‰1ä»½æ²¡é¢†å–
    }

    // éªŒè¯é¢†å–è®°å½•
    let claimId = "1-" + claimer.toHex()
    let claim = Claim.load(claimId)
    assert.assertNotNull(claim)
    
    if (claim !== null) {
      assert.stringEquals(claim.redPacket, "1")
      assert.bytesEquals(claim.claimer, claimer)
      assert.bigIntEquals(claim.amount, claimAmount)
      assert.i32Equals(claim.claimIndex, 1)
    }
  })

  test("Should mark red packet as inactive when fully claimed", () => {
    // åˆ›å»ºåªæœ‰1ä»½çš„çº¢åŒ…
    let packetId = BigInt.fromI32(1)
    let creator = Address.fromString("0x1234567890123456789012345678901234567890")
    let claimer = Address.fromString("0x0987654321098765432109876543210987654321")
    
    let createEvent = createPacketCreatedEvent(
      packetId,
      creator,
      "Single packet",
      BigInt.fromString("1000000000000000000"),
      BigInt.fromI32(1),
      true
    )
    handlePacketCreated(createEvent)

    // é¢†å–è¿™å”¯ä¸€çš„çº¢åŒ…
    let claimEvent = createPacketClaimedEvent(
      packetId, 
      claimer, 
      BigInt.fromString("1000000000000000000")
    )
    handlePacketClaimed(claimEvent)

    // éªŒè¯çº¢åŒ…å˜ä¸ºéæ´»è·ƒçŠ¶æ€
    let redPacket = RedPacket.load("1")
    assert.assertNotNull(redPacket)
    
    if (redPacket !== null) {
      assert.i32Equals(redPacket.claimedCount, 1)
      assert.bigIntEquals(redPacket.balance, BigInt.fromI32(0))
      assert.booleanEquals(redPacket.isActive, false)
      assert.stringEquals(redPacket.completionRate.toString(), "1")
    }
  })
})
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# ç”Ÿæˆç±»å‹æ–‡ä»¶
npm run codegen

# è¿è¡Œæµ‹è¯•
graph test
```

## ğŸš€ éƒ¨ç½²ä¸å‘å¸ƒ

### 1. å‡†å¤‡éƒ¨ç½²

```bash
# ç”Ÿæˆç±»å‹å’Œæ„å»º
npm run codegen
npm run build
```

### 2. éƒ¨ç½²åˆ° Graph Studio

```bash
# é¦–å…ˆéœ€è¦åœ¨ https://thegraph.com/studio/ åˆ›å»ºå­å›¾

# æˆæƒï¼ˆéœ€è¦ä»Studioè·å–è®¿é—®ä»¤ç‰Œï¼‰
graph auth --studio YOUR_ACCESS_TOKEN

# éƒ¨ç½²
npm run deploy
```

### 3. ç‰ˆæœ¬ç®¡ç†

**éƒ¨ç½²å¤šä¸ªç‰ˆæœ¬**:
```bash
# éƒ¨ç½²åˆ°ä¸åŒæ ‡ç­¾
graph deploy --studio red-packet-subgraph --version-label v1.0.0
graph deploy --studio red-packet-subgraph --version-label v1.0.1
```

### 4. ç›‘æ§ä¸ç»´æŠ¤

**æ£€æŸ¥åŒæ­¥çŠ¶æ€**:
```bash
# é€šè¿‡GraphQLæŸ¥è¯¢å­å›¾çŠ¶æ€
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"query": "{ _meta { block { number } } }"}' \
  https://api.studio.thegraph.com/query/your-subgraph-id/your-subgraph-name/version/latest
```

## ğŸ“Š å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. åŸºç¡€æŸ¥è¯¢

```graphql
# è·å–æœ€æ–°çš„20ä¸ªçº¢åŒ…
query GetRecentPackets {
  redPackets(
    first: 20
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    totalCount
    claimedCount
    isEven
    isActive
    creationTime
    claims {
      claimer
      amount
      timestamp
    }
  }
}

# è·å–ç”¨æˆ·åˆ›å»ºçš„çº¢åŒ…
query GetUserPackets($creator: Bytes!) {
  redPackets(
    where: { creator: $creator }
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    message
    totalAmount
    totalCount
    claimedCount
    isActive
    completionRate
  }
}

# è·å–ç”¨æˆ·çš„é¢†å–è®°å½•
query GetUserClaims($claimer: Bytes!) {
  claims(
    where: { claimer: $claimer }
    orderBy: timestamp
    orderDirection: desc
  ) {
    id
    redPacket {
      id
      message
      creator
    }
    amount
    timestamp
    claimIndex
  }
}
```

### 2. ç»Ÿè®¡æŸ¥è¯¢

```graphql
# è·å–å…¨å±€ç»Ÿè®¡
query GetGlobalStats {
  globalStats(id: "global") {
    totalPackets
    totalAmount
    totalClaims
    activePackets
    totalUsers
    lastUpdated
  }
}

# è·å–æ¯æ—¥ç»Ÿè®¡
query GetDayStats($startDate: String!, $endDate: String!) {
  dayStats(
    where: {
      id_gte: $startDate
      id_lte: $endDate
    }
    orderBy: date
    orderDirection: asc
  ) {
    id
    date
    packetsCreated
    packetsClaimed
    amountCreated
    amountClaimed
    activeUsers
  }
}

# è·å–ç”¨æˆ·ç»Ÿè®¡
query GetUserStats($userId: ID!) {
  user(id: $userId) {
    address
    createdPacketsCount
    totalAmountCreated
    claimedPacketsCount
    totalAmountClaimed
    firstActivity
    lastActivity
  }
}
```

### 3. å¤æ‚æŸ¥è¯¢

```graphql
# è·å–æ´»è·ƒçº¢åŒ…ï¼ˆå¯é¢†å–çš„ï¼‰
query GetActivePackets($first: Int = 10) {
  redPackets(
    where: { isActive: true }
    first: $first
    orderBy: creationTime
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    balance
    totalCount
    claimedCount
    averageAmount
    completionRate
  }
}

# è·å–å¤§é¢çº¢åŒ…ï¼ˆæ€»é‡‘é¢å¤§äº1 ETHï¼‰
query GetLargePackets {
  redPackets(
    where: { totalAmount_gte: "1000000000000000000" }
    orderBy: totalAmount
    orderDirection: desc
  ) {
    id
    creator
    message
    totalAmount
    totalCount
    isEven
    creationTime
  }
}

# è·å–çº¢åŒ…è¯¦æƒ…å’Œæ‰€æœ‰é¢†å–è®°å½•
query GetPacketDetails($packetId: ID!) {
  redPacket(id: $packetId) {
    id
    creator
    message
    totalAmount
    balance
    totalCount
    claimedCount
    isEven
    isActive
    creationTime
    completionRate
    claims(orderBy: timestamp, orderDirection: asc) {
      claimer
      amount
      timestamp
      claimIndex
      transactionHash
    }
  }
}
```

## ğŸ› ï¸ è°ƒè¯•ä¸ä¼˜åŒ–

### 1. è°ƒè¯•æŠ€å·§

**æ—¥å¿—è°ƒè¯•**:
```typescript
import { log } from "@graphprotocol/graph-ts"

export function handlePacketCreated(event: PacketCreated): void {
  log.info("Processing PacketCreated event for packet {}", [event.params.packetId.toString()])
  
  // å¤„ç†é€»è¾‘...
  
  log.info("Successfully processed packet {} with amount {}", [
    event.params.packetId.toString(),
    event.params.totalAmount.toString()
  ])
}
```

**é”™è¯¯å¤„ç†**:
```typescript
export function handlePacketClaimed(event: PacketClaimed): void {
  let redPacket = RedPacket.load(event.params.packetId.toString())
  
  if (redPacket === null) {
    log.error("RedPacket with id {} not found", [event.params.packetId.toString()])
    return  // ä¼˜é›…å¤„ç†é”™è¯¯ï¼Œä¸è¦è®©å­å›¾å¤±è´¥
  }

  // ç»§ç»­å¤„ç†...
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡æ“ä½œ**:
```typescript
// é¿å…åœ¨å¾ªç¯ä¸­å¤šæ¬¡ä¿å­˜åŒä¸€ä¸ªå®ä½“
let user = getOrCreateUser(event.params.creator)
user.createdPacketsCount = user.createdPacketsCount + 1
user.totalAmountCreated = user.totalAmountCreated.plus(event.params.totalAmount)
user.lastActivity = event.block.timestamp
user.save() // åªä¿å­˜ä¸€æ¬¡
```

**åˆç†çš„å®ä½“å…³ç³»**:
```typescript
// ä½¿ç”¨ @derivedFrom é¿å…æ‰‹åŠ¨ç»´æŠ¤åŒå‘å…³ç³»
// åœ¨ schema.graphql ä¸­ï¼š
# claims: [Claim!]! @derivedFrom(field: "redPacket")
```

### 3. ç›‘æ§æŒ‡æ ‡

**ç›‘æ§å­å›¾å¥åº·çŠ¶æ€**:
```typescript
// åœ¨æ˜ å°„ä¸­æ·»åŠ å¥åº·æ£€æŸ¥
let globalStats = getOrCreateGlobalStats()
globalStats.lastUpdated = event.block.timestamp

// å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ›´æ–°ï¼Œè¯´æ˜å¯èƒ½æœ‰é—®é¢˜
if (event.block.timestamp.gt(globalStats.lastUpdated.plus(BigInt.fromI32(3600)))) {
  log.warning("Subgraph might be lagging, last update was {} seconds ago", [
    event.block.timestamp.minus(globalStats.lastUpdated).toString()
  ])
}
```

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### 1. æ•°æ®æ¨¡å‹è®¾è®¡
- **å®ä½“å…³ç³»æ¸…æ™°**: åˆç†è®¾è®¡ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»
- **å­—æ®µç±»å‹é€‰æ‹©**: ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹ï¼ˆBigInt for wei amountsï¼‰
- **ç´¢å¼•ç­–ç•¥**: ç»å¸¸æŸ¥è¯¢çš„å­—æ®µæ·»åŠ ç´¢å¼•
- **è®¡ç®—å­—æ®µ**: åœ¨æ˜ å°„ä¸­è®¡ç®—å¸¸ç”¨çš„æ´¾ç”Ÿå­—æ®µ

### 2. æ˜ å°„é€»è¾‘
- **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†ç©ºå€¼å’Œå¼‚å¸¸æƒ…å†µ
- **æ€§èƒ½ä¼˜åŒ–**: é¿å…ä¸å¿…è¦çš„å®ä½“åŠ è½½å’Œä¿å­˜
- **æ—¥å¿—è®°å½•**: åˆç†æ·»åŠ æ—¥å¿—ç”¨äºè°ƒè¯•
- **ç‰ˆæœ¬å…¼å®¹**: è€ƒè™‘åˆçº¦å‡çº§å’Œæ•°æ®è¿ç§»

### 3. æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æµ‹è¯•æ¯ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°
- **é›†æˆæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- **è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•æç«¯æƒ…å†µå’Œé”™è¯¯å¤„ç†
- **æ€§èƒ½æµ‹è¯•**: ç¡®ä¿å¤§é‡æ•°æ®ä¸‹çš„æ€§èƒ½

### 4. éƒ¨ç½²è¿ç»´
- **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬å·ç®¡ç†å­å›¾ç‰ˆæœ¬
- **ç›‘æ§å‘Šè­¦**: ç›‘æ§åŒæ­¥çŠ¶æ€å’ŒæŸ¥è¯¢æ€§èƒ½
- **å¤‡ä»½ç­–ç•¥**: é‡è¦æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤
- **æ–‡æ¡£ç»´æŠ¤**: ä¿æŒæŸ¥è¯¢æ–‡æ¡£å’ŒAPIæ–‡æ¡£æœ€æ–°

é€šè¿‡è¿™å¥—å®Œæ•´çš„Subgraphå¼€å‘æŒ‡å—ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªé«˜æ•ˆã€å¯é ã€å¯æ‰©å±•çš„æ•°æ®ç´¢å¼•ç³»ç»Ÿï¼Œä¸ºçº¢åŒ…DAppæä¾›äº†å¼ºå¤§çš„æ•°æ®æ”¯æŒï¼Œæ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒå’Œåº”ç”¨æ€§èƒ½ã€‚