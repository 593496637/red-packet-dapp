# 🎨 前端开发完整指南

## 📋 开发前准备

### 需求分析
前端作为用户直接交互的界面，需要提供直观、友好的Web3体验：

1. **核心功能需求**
   - 钱包连接与状态管理
   - 创建红包界面（金额、份数、祝福语）
   - 红包列表展示与实时更新
   - 抢红包交互与结果反馈
   - 交易状态追踪与错误处理

2. **用户体验需求**
   - 响应式设计，支持移动端
   - 加载状态与交互反馈
   - 友好的错误提示
   - 实时数据更新
   - 直观的Web3操作引导

3. **技术性能需求**
   - 快速首屏加载
   - 高效的状态管理
   - 优化的网络请求
   - 良好的SEO支持

### 技术架构设计

```
前端应用架构
├── 界面层 (UI Layer)
│   ├── 组件设计系统
│   ├── 页面路由管理
│   └── 响应式布局
├── 状态管理层 (State Layer)
│   ├── Web3状态 (Wagmi)
│   ├── 服务端状态 (React Query)
│   └── 客户端状态 (useState)
├── 服务层 (Service Layer)
│   ├── 智能合约交互
│   ├── GraphQL查询
│   └── 工具函数
└── 数据层 (Data Layer)
    ├── 合约ABI
    ├── 类型定义
    └── 常量配置
```

## 🏗️ 开发环境搭建

### 1. 项目初始化

```bash
# 创建Vite + React + TypeScript项目
npm create vite@latest red-packet-frontend -- --template react-ts
cd red-packet-frontend

# 安装基础依赖
npm install
```

### 2. 安装Web3依赖

```bash
# 核心Web3库
npm install wagmi viem @tanstack/react-query

# Wallet Connectors
npm install @wagmi/connectors

# GraphQL客户端
npm install @apollo/client graphql

# UI和样式库
npm install @radix-ui/react-dialog @radix-ui/react-toast
npm install lucide-react clsx tailwind-merge

# 工具库
npm install @viem/anvil
```

### 3. 开发工具配置

```bash
# 开发依赖
npm install --save-dev @types/node
npm install --save-dev tailwindcss postcss autoprefixer
npm install --save-dev eslint-plugin-react-hooks
```

### 4. Tailwind CSS配置

**tailwind.config.js**:
```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#fef2f2',
          100: '#fee2e2', 
          500: '#ef4444',
          600: '#dc2626',
          700: '#b91c1c',
        },
        accent: {
          50: '#fff7ed',
          100: '#ffedd5',
          500: '#f97316',
          600: '#ea580c',
        }
      },
      animation: {
        'bounce-slow': 'bounce 2s infinite',
        'pulse-fast': 'pulse 1s infinite',
      }
    },
  },
  plugins: [],
}
```

### 5. TypeScript配置优化

**tsconfig.json**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/hooks/*": ["./src/hooks/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/types/*": ["./src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

## 💡 核心架构实现

### 1. Web3配置设置

**src/lib/web3.ts**:
```typescript
import { createConfig, http } from 'wagmi'
import { sepolia } from 'wagmi/chains'
import { injected, metaMask, walletConnect } from 'wagmi/connectors'
import { QueryClient } from '@tanstack/react-query'

// 创建查询客户端
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 2, // 2分钟
      cacheTime: 1000 * 60 * 10, // 10分钟
      refetchOnWindowFocus: false,
      retry: 3,
    },
  },
})

// Wagmi配置
export const wagmiConfig = createConfig({
  chains: [sepolia],
  connectors: [
    injected(),
    metaMask(),
    walletConnect({ 
      projectId: import.meta.env.VITE_WALLET_CONNECT_PROJECT_ID 
    }),
  ],
  transports: {
    [sepolia.id]: http(import.meta.env.VITE_SEPOLIA_RPC_URL),
  },
  ssr: false,
})

// 合约配置
export const RED_PACKET_ADDRESS = '0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f' as const
export const SEPOLIA_CHAIN_ID = sepolia.id
```

### 2. 合约ABI和类型定义

**src/types/contracts.ts**:
```typescript
import type { Address } from 'viem'

// 红包结构体类型
export interface RedPacket {
  owner: Address
  message: string
  totalAmount: bigint
  balance: bigint
  totalCount: bigint
  claimedCount: bigint
  isEven: boolean
  creationTime: bigint
}

// 红包创建参数
export interface CreateRedPacketParams {
  message: string
  count: bigint
  isEven: boolean
  value: bigint
}

// 事件类型
export interface PacketCreatedEvent {
  packetId: bigint
  creator: Address
  message: string
  totalAmount: bigint
  totalCount: bigint
  isEven: boolean
}

export interface PacketClaimedEvent {
  packetId: bigint
  claimer: Address
  amount: bigint
}

// 合约ABI
export const RED_PACKET_ABI = [
  {
    type: 'function',
    name: 'createRedPacket',
    inputs: [
      { name: '_message', type: 'string' },
      { name: '_count', type: 'uint256' },
      { name: '_isEven', type: 'bool' }
    ],
    outputs: [],
    stateMutability: 'payable'
  },
  {
    type: 'function',
    name: 'claimRedPacket',
    inputs: [{ name: '_packetId', type: 'uint256' }],
    outputs: [],
    stateMutability: 'nonpayable'
  },
  {
    type: 'function',
    name: 'packets',
    inputs: [{ name: '', type: 'uint256' }],
    outputs: [
      { name: 'owner', type: 'address' },
      { name: 'message', type: 'string' },
      { name: 'totalAmount', type: 'uint256' },
      { name: 'balance', type: 'uint256' },
      { name: 'totalCount', type: 'uint256' },
      { name: 'claimedCount', type: 'uint256' },
      { name: 'isEven', type: 'bool' },
      { name: 'creationTime', type: 'uint256' }
    ],
    stateMutability: 'view'
  },
  {
    type: 'function',
    name: 'hasClaimed',
    inputs: [
      { name: '', type: 'uint256' },
      { name: '', type: 'address' }
    ],
    outputs: [{ name: '', type: 'bool' }],
    stateMutability: 'view'
  },
  {
    type: 'event',
    name: 'PacketCreated',
    inputs: [
      { name: 'packetId', type: 'uint256', indexed: true },
      { name: 'creator', type: 'address', indexed: true },
      { name: 'message', type: 'string', indexed: false },
      { name: 'totalAmount', type: 'uint256', indexed: false },
      { name: 'totalCount', type: 'uint256', indexed: false },
      { name: 'isEven', type: 'bool', indexed: false }
    ]
  },
  {
    type: 'event',
    name: 'PacketClaimed',
    inputs: [
      { name: 'packetId', type: 'uint256', indexed: true },
      { name: 'claimer', type: 'address', indexed: true },
      { name: 'amount', type: 'uint256', indexed: false }
    ]
  }
] as const
```

### 3. 自定义Hooks设计

**src/hooks/useRedPacket.ts**:
```typescript
import { useReadContract, useWriteContract, useWaitForTransactionReceipt } from 'wagmi'
import { RED_PACKET_ADDRESS, RED_PACKET_ABI } from '@/lib/web3'
import { toast } from 'sonner'
import type { CreateRedPacketParams } from '@/types/contracts'

// 读取红包信息
export function useRedPacket(packetId: bigint) {
  return useReadContract({
    address: RED_PACKET_ADDRESS,
    abi: RED_PACKET_ABI,
    functionName: 'packets',
    args: [packetId],
    query: {
      enabled: packetId > 0n,
      refetchInterval: 5000, // 5秒自动刷新
    }
  })
}

// 检查是否已领取
export function useHasClaimed(packetId: bigint, address?: `0x${string}`) {
  return useReadContract({
    address: RED_PACKET_ADDRESS,
    abi: RED_PACKET_ABI,
    functionName: 'hasClaimed',
    args: [packetId, address!],
    query: {
      enabled: Boolean(address && packetId > 0n),
    }
  })
}

// 创建红包
export function useCreateRedPacket() {
  const { writeContract, data: hash, isPending } = useWriteContract()
  
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ 
    hash 
  })

  const createRedPacket = async (params: CreateRedPacketParams) => {
    try {
      await writeContract({
        address: RED_PACKET_ADDRESS,
        abi: RED_PACKET_ABI,
        functionName: 'createRedPacket',
        args: [params.message, params.count, params.isEven],
        value: params.value,
      })
      
      toast.success('红包创建交易已提交，等待确认...')
    } catch (error) {
      toast.error('红包创建失败')
      throw error
    }
  }

  return {
    createRedPacket,
    isLoading: isPending || isConfirming,
    isSuccess,
    hash
  }
}

// 抢红包
export function useClaimRedPacket() {
  const { writeContract, data: hash, isPending } = useWriteContract()
  
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ 
    hash 
  })

  const claimRedPacket = async (packetId: bigint) => {
    try {
      await writeContract({
        address: RED_PACKET_ADDRESS,
        abi: RED_PACKET_ABI,
        functionName: 'claimRedPacket',
        args: [packetId],
      })
      
      toast.success('抢红包交易已提交，等待确认...')
    } catch (error) {
      toast.error('抢红包失败')
      throw error
    }
  }

  return {
    claimRedPacket,
    isLoading: isPending || isConfirming,
    isSuccess,
    hash
  }
}
```

### 4. GraphQL集成

**src/lib/apollo.ts**:
```typescript
import { ApolloClient, InMemoryCache, createHttpLink } from '@apollo/client'

const httpLink = createHttpLink({
  uri: import.meta.env.VITE_SUBGRAPH_URL || 'https://api.studio.thegraph.com/query/your-subgraph',
})

export const apolloClient = new ApolloClient({
  link: httpLink,
  cache: new InMemoryCache({
    typePolicies: {
      RedPacket: {
        keyFields: ['id'],
      },
      Claim: {
        keyFields: ['id'],
      },
    },
  }),
  defaultOptions: {
    watchQuery: {
      fetchPolicy: 'cache-and-network',
      pollInterval: 10000, // 10秒轮询
    },
  },
})
```

**src/graphql/queries.ts**:
```typescript
import { gql } from '@apollo/client'

export const GET_RED_PACKETS = gql`
  query GetRedPackets($first: Int = 10, $skip: Int = 0, $orderBy: String = "creationTime", $orderDirection: String = "desc") {
    redPackets(first: $first, skip: $skip, orderBy: $orderBy, orderDirection: $orderDirection) {
      id
      creator
      message
      totalAmount
      totalCount
      claimedCount
      isEven
      creationTime
      claims {
        id
        claimer
        amount
        timestamp
      }
    }
  }
`

export const GET_USER_PACKETS = gql`
  query GetUserPackets($creator: Bytes!) {
    redPackets(where: { creator: $creator }, orderBy: creationTime, orderDirection: desc) {
      id
      message
      totalAmount
      totalCount
      claimedCount
      isEven
      creationTime
      claims {
        id
        claimer
        amount
        timestamp
      }
    }
  }
`

export const GET_PACKET_CLAIMS = gql`
  query GetPacketClaims($packetId: ID!) {
    redPacket(id: $packetId) {
      id
      creator
      message
      totalAmount
      totalCount
      claimedCount
      claims {
        id
        claimer
        amount
        timestamp
      }
    }
  }
`
```

## 🎨 组件开发实战

### 1. 钱包连接组件

**src/components/ConnectWallet.tsx**:
```tsx
import { useAccount, useConnect, useDisconnect } from 'wagmi'
import { Button } from '@/components/ui/Button'
import { Wallet, LogOut } from 'lucide-react'
import { toast } from 'sonner'

export function ConnectWallet() {
  const { address, isConnected } = useAccount()
  const { connect, connectors, isPending } = useConnect({
    mutation: {
      onSuccess: () => {
        toast.success('钱包连接成功!')
      },
      onError: (error) => {
        toast.error(`连接失败: ${error.message}`)
      }
    }
  })
  const { disconnect } = useDisconnect()

  if (isConnected) {
    return (
      <div className="flex items-center gap-4">
        <div className="text-sm text-gray-600">
          {address?.slice(0, 6)}...{address?.slice(-4)}
        </div>
        <Button 
          variant="outline" 
          size="sm"
          onClick={() => disconnect()}
          className="flex items-center gap-2"
        >
          <LogOut className="w-4 h-4" />
          断开连接
        </Button>
      </div>
    )
  }

  return (
    <div className="flex flex-col gap-2">
      <h3 className="text-lg font-semibold mb-2">连接钱包</h3>
      {connectors.map((connector) => (
        <Button
          key={connector.id}
          onClick={() => connect({ connector })}
          disabled={isPending}
          className="flex items-center gap-2"
        >
          <Wallet className="w-4 h-4" />
          连接到 {connector.name}
          {isPending && connector.id === connector.id && ' (连接中...)'}
        </Button>
      ))}
    </div>
  )
}
```

### 2. 创建红包组件

**src/components/CreateRedPacket.tsx**:
```tsx
import { useState, useEffect } from 'react'
import { parseEther, formatEther } from 'viem'
import { useCreateRedPacket } from '@/hooks/useRedPacket'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Label } from '@/components/ui/Label'
import { Switch } from '@/components/ui/Switch'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card'
import { Gift, Loader2 } from 'lucide-react'
import { toast } from 'sonner'

export function CreateRedPacket() {
  const [formData, setFormData] = useState({
    message: '',
    amount: '',
    count: '',
    isEven: false
  })
  const [errors, setErrors] = useState<Record<string, string>>({})

  const { createRedPacket, isLoading, isSuccess, hash } = useCreateRedPacket()

  // 表单验证
  const validateForm = () => {
    const newErrors: Record<string, string> = {}

    if (!formData.message.trim()) {
      newErrors.message = '请输入祝福语'
    }

    if (!formData.amount || parseFloat(formData.amount) <= 0) {
      newErrors.amount = '请输入有效的红包金额'
    }

    if (!formData.count || parseInt(formData.count) <= 0) {
      newErrors.count = '请输入有效的红包份数'
    }

    const amount = parseFloat(formData.amount || '0')
    const count = parseInt(formData.count || '0')
    if (amount > 0 && count > 0 && amount / count < 0.000001) {
      newErrors.amount = '每份红包至少需要 0.000001 ETH'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!validateForm()) return

    try {
      await createRedPacket({
        message: formData.message,
        count: BigInt(formData.count),
        isEven: formData.isEven,
        value: parseEther(formData.amount)
      })
    } catch (error) {
      console.error('创建红包失败:', error)
    }
  }

  // 成功后重置表单
  useEffect(() => {
    if (isSuccess) {
      setFormData({ message: '', amount: '', count: '', isEven: false })
      toast.success('红包创建成功！')
    }
  }, [isSuccess])

  return (
    <Card className="max-w-md mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Gift className="w-5 h-5 text-primary-600" />
          创建红包
        </CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="message">祝福语</Label>
            <Input
              id="message"
              value={formData.message}
              onChange={(e) => setFormData(prev => ({ ...prev, message: e.target.value }))}
              placeholder="恭喜发财，红包拿来！"
              maxLength={100}
            />
            {errors.message && <p className="text-sm text-red-500 mt-1">{errors.message}</p>}
          </div>

          <div>
            <Label htmlFor="amount">红包总金额 (ETH)</Label>
            <Input
              id="amount"
              type="number"
              step="0.001"
              min="0"
              value={formData.amount}
              onChange={(e) => setFormData(prev => ({ ...prev, amount: e.target.value }))}
              placeholder="0.1"
            />
            {errors.amount && <p className="text-sm text-red-500 mt-1">{errors.amount}</p>}
          </div>

          <div>
            <Label htmlFor="count">红包份数</Label>
            <Input
              id="count"
              type="number"
              min="1"
              max="100"
              value={formData.count}
              onChange={(e) => setFormData(prev => ({ ...prev, count: e.target.value }))}
              placeholder="5"
            />
            {errors.count && <p className="text-sm text-red-500 mt-1">{errors.count}</p>}
          </div>

          <div className="flex items-center justify-between">
            <Label htmlFor="isEven" className="text-sm font-medium">
              均分模式
            </Label>
            <Switch
              id="isEven"
              checked={formData.isEven}
              onCheckedChange={(checked) => setFormData(prev => ({ ...prev, isEven: checked }))}
            />
          </div>

          {formData.amount && formData.count && (
            <div className="p-3 bg-gray-50 rounded-lg text-sm">
              {formData.isEven ? (
                <p>每个红包: <span className="font-semibold">{(parseFloat(formData.amount) / parseInt(formData.count)).toFixed(6)} ETH</span></p>
              ) : (
                <p>随机红包: <span className="font-semibold">0.000001 ~ {(parseFloat(formData.amount) / parseInt(formData.count) * 2).toFixed(6)} ETH</span></p>
              )}
            </div>
          )}

          <Button 
            type="submit" 
            className="w-full" 
            disabled={isLoading}
            size="lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                创建中...
              </>
            ) : (
              <>
                <Gift className="w-4 h-4 mr-2" />
                创建红包
              </>
            )}
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}
```

### 3. 红包列表组件

**src/components/RedPacketList.tsx**:
```tsx
import { useQuery } from '@apollo/client'
import { useAccount } from 'wagmi'
import { formatEther } from 'viem'
import { GET_RED_PACKETS } from '@/graphql/queries'
import { RedPacketCard } from './RedPacketCard'
import { Loader2, Gift } from 'lucide-react'

interface RedPacket {
  id: string
  creator: string
  message: string
  totalAmount: string
  totalCount: number
  claimedCount: number
  isEven: boolean
  creationTime: string
  claims: Array<{
    id: string
    claimer: string
    amount: string
    timestamp: string
  }>
}

export function RedPacketList() {
  const { address } = useAccount()
  const { data, loading, error, refetch } = useQuery(GET_RED_PACKETS, {
    variables: {
      first: 20,
      skip: 0,
      orderBy: 'creationTime',
      orderDirection: 'desc'
    },
    pollInterval: 10000, // 10秒轮询
  })

  if (loading) {
    return (
      <div className="flex justify-center items-center py-12">
        <Loader2 className="w-8 h-8 animate-spin text-primary-600" />
        <span className="ml-2 text-gray-600">加载红包列表中...</span>
      </div>
    )
  }

  if (error) {
    return (
      <div className="text-center py-12">
        <p className="text-red-500 mb-4">加载失败: {error.message}</p>
        <button 
          onClick={() => refetch()} 
          className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
        >
          重试
        </button>
      </div>
    )
  }

  const packets: RedPacket[] = data?.redPackets || []

  if (packets.length === 0) {
    return (
      <div className="text-center py-12">
        <Gift className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <h3 className="text-lg font-semibold text-gray-600 mb-2">暂无红包</h3>
        <p className="text-gray-500">成为第一个创建红包的人吧！</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-800 mb-6">红包大厅</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {packets.map((packet) => (
          <RedPacketCard 
            key={packet.id} 
            packet={packet} 
            currentUser={address}
            onClaimed={() => refetch()}
          />
        ))}
      </div>
    </div>
  )
}
```

### 4. 红包卡片组件

**src/components/RedPacketCard.tsx**:
```tsx
import { useState, useEffect } from 'react'
import { formatEther, type Address } from 'viem'
import { useClaimRedPacket, useHasClaimed } from '@/hooks/useRedPacket'
import { Button } from '@/components/ui/Button'
import { Card, CardContent, CardHeader } from '@/components/ui/Card'
import { Badge } from '@/components/ui/Badge'
import { 
  Gift, 
  Users, 
  Clock, 
  Loader2, 
  CheckCircle2, 
  XCircle,
  Coins,
  User
} from 'lucide-react'
import { toast } from 'sonner'
import { cn } from '@/lib/utils'

interface RedPacketCardProps {
  packet: {
    id: string
    creator: string
    message: string
    totalAmount: string
    totalCount: number
    claimedCount: number
    isEven: boolean
    creationTime: string
    claims: Array<{
      claimer: string
      amount: string
      timestamp: string
    }>
  }
  currentUser?: Address
  onClaimed?: () => void
}

export function RedPacketCard({ packet, currentUser, onClaimed }: RedPacketCardProps) {
  const [showClaims, setShowClaims] = useState(false)
  
  const { claimRedPacket, isLoading } = useClaimRedPacket()
  const { data: hasClaimed } = useHasClaimed(BigInt(packet.id), currentUser)

  const isOwner = currentUser && packet.creator.toLowerCase() === currentUser.toLowerCase()
  const isFullyClaimed = packet.claimedCount >= packet.totalCount
  const canClaim = currentUser && !hasClaimed && !isOwner && !isFullyClaimed

  const handleClaim = async () => {
    if (!canClaim) return

    try {
      await claimRedPacket(BigInt(packet.id))
      // 等待一小段时间让交易确认，然后刷新
      setTimeout(() => {
        onClaimed?.()
      }, 2000)
    } catch (error) {
      console.error('抢红包失败:', error)
    }
  }

  const formatTime = (timestamp: string) => {
    return new Date(parseInt(timestamp) * 1000).toLocaleString('zh-CN')
  }

  const getRemainingAmount = () => {
    const total = BigInt(packet.totalAmount)
    const claimed = packet.claims.reduce((sum, claim) => sum + BigInt(claim.amount), 0n)
    return total - claimed
  }

  const getStatusColor = () => {
    if (isFullyClaimed) return 'bg-gray-100 text-gray-600'
    if (hasClaimed) return 'bg-green-100 text-green-700'
    if (canClaim) return 'bg-red-100 text-red-700'
    return 'bg-blue-100 text-blue-700'
  }

  const getStatusText = () => {
    if (isFullyClaimed) return '已抢完'
    if (hasClaimed) return '已领取'
    if (isOwner) return '我的红包'
    if (!currentUser) return '请先连接钱包'
    return '可抢取'
  }

  return (
    <Card className={cn(
      "relative overflow-hidden transition-all duration-200 hover:shadow-lg",
      canClaim && "border-red-200 hover:border-red-300",
      hasClaimed && "border-green-200",
      isFullyClaimed && "border-gray-200 opacity-75"
    )}>
      <CardHeader className="pb-3">
        <div className="flex justify-between items-start">
          <div className="flex-1">
            <h3 className="font-semibold text-gray-800 mb-1 line-clamp-2">
              {packet.message}
            </h3>
            <div className="flex items-center gap-2 text-sm text-gray-500">
              <User className="w-3 h-3" />
              {packet.creator.slice(0, 6)}...{packet.creator.slice(-4)}
            </div>
          </div>
          <Badge className={getStatusColor()}>
            {getStatusText()}
          </Badge>
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div className="flex items-center gap-2">
            <Coins className="w-4 h-4 text-amber-500" />
            <span className="text-gray-600">总金额</span>
          </div>
          <div className="font-semibold text-right">
            {parseFloat(formatEther(BigInt(packet.totalAmount))).toFixed(4)} ETH
          </div>

          <div className="flex items-center gap-2">
            <Users className="w-4 h-4 text-blue-500" />
            <span className="text-gray-600">进度</span>
          </div>
          <div className="font-semibold text-right">
            {packet.claimedCount}/{packet.totalCount}
          </div>

          <div className="flex items-center gap-2">
            <Gift className="w-4 h-4 text-purple-500" />
            <span className="text-gray-600">模式</span>
          </div>
          <div className="text-right">
            {packet.isEven ? '均分' : '随机'}
          </div>

          <div className="flex items-center gap-2">
            <Clock className="w-4 h-4 text-gray-400" />
            <span className="text-gray-600">时间</span>
          </div>
          <div className="text-right text-xs">
            {formatTime(packet.creationTime)}
          </div>
        </div>

        {!isFullyClaimed && (
          <div className="bg-amber-50 p-3 rounded-lg">
            <div className="text-sm text-amber-700">
              剩余: {parseFloat(formatEther(getRemainingAmount())).toFixed(4)} ETH
            </div>
            <div className="w-full bg-amber-200 rounded-full h-2 mt-2">
              <div 
                className="bg-amber-500 h-2 rounded-full transition-all duration-300"
                style={{ width: `${(packet.claimedCount / packet.totalCount) * 100}%` }}
              />
            </div>
          </div>
        )}

        {canClaim && (
          <Button
            onClick={handleClaim}
            disabled={isLoading}
            className="w-full bg-red-600 hover:bg-red-700"
            size="lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                抢红包中...
              </>
            ) : (
              <>
                <Gift className="w-4 h-4 mr-2" />
                抢红包
              </>
            )}
          </Button>
        )}

        {packet.claims.length > 0 && (
          <Button
            variant="outline"
            onClick={() => setShowClaims(!showClaims)}
            className="w-full"
            size="sm"
          >
            {showClaims ? '隐藏' : '查看'}领取记录 ({packet.claims.length})
          </Button>
        )}

        {showClaims && packet.claims.length > 0 && (
          <div className="space-y-2 max-h-40 overflow-y-auto">
            {packet.claims.map((claim, index) => (
              <div key={claim.claimer + claim.timestamp} className="flex justify-between items-center text-xs bg-gray-50 p-2 rounded">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                    <span className="text-green-600 font-bold">#{index + 1}</span>
                  </div>
                  <span className="text-gray-600">
                    {claim.claimer.slice(0, 6)}...{claim.claimer.slice(-4)}
                  </span>
                </div>
                <div className="font-semibold text-green-600">
                  {parseFloat(formatEther(BigInt(claim.amount))).toFixed(4)} ETH
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

## 🎯 高级特性实现

### 1. 实时状态更新

**src/hooks/useRealTimeUpdates.ts**:
```typescript
import { useEffect } from 'react'
import { useWatchContractEvent } from 'wagmi'
import { RED_PACKET_ADDRESS, RED_PACKET_ABI } from '@/lib/web3'
import { toast } from 'sonner'
import { formatEther } from 'viem'

export function useRealTimeUpdates() {
  // 监听红包创建事件
  useWatchContractEvent({
    address: RED_PACKET_ADDRESS,
    abi: RED_PACKET_ABI,
    eventName: 'PacketCreated',
    onLogs(logs) {
      logs.forEach((log) => {
        const { creator, message, totalAmount } = log.args
        toast.success(
          `新红包来啦！${creator?.slice(0, 6)}...${creator?.slice(-4)} 发了一个 ${parseFloat(formatEther(totalAmount!)).toFixed(4)} ETH 的红包`,
          {
            duration: 5000,
            action: {
              label: '去抢',
              onClick: () => {
                // 滚动到红包列表或刷新页面
                window.location.reload()
              }
            }
          }
        )
      })
    }
  })

  // 监听红包领取事件
  useWatchContractEvent({
    address: RED_PACKET_ADDRESS,
    abi: RED_PACKET_ABI,
    eventName: 'PacketClaimed',
    onLogs(logs) {
      logs.forEach((log) => {
        const { claimer, amount } = log.args
        toast.info(
          `${claimer?.slice(0, 6)}...${claimer?.slice(-4)} 抢到了 ${parseFloat(formatEther(amount!)).toFixed(4)} ETH`,
          { duration: 3000 }
        )
      })
    }
  })

  // 监听红包抢完事件
  useWatchContractEvent({
    address: RED_PACKET_ADDRESS,
    abi: RED_PACKET_ABI,
    eventName: 'PacketEmpty',
    onLogs(logs) {
      logs.forEach((log) => {
        toast.warning(`红包 #${log.args.packetId} 已被抢完！`, { duration: 3000 })
      })
    }
  })
}
```

### 2. 错误处理与用户反馈

**src/hooks/useErrorHandler.ts**:
```typescript
import { useEffect } from 'react'
import { toast } from 'sonner'

interface ErrorInfo {
  code?: number
  message?: string
  reason?: string
}

export function useErrorHandler() {
  const handleError = (error: any) => {
    console.error('App Error:', error)

    // 解析错误信息
    let message = '操作失败，请重试'
    
    if (error?.message?.includes('User rejected')) {
      message = '用户取消了交易'
    } else if (error?.message?.includes('insufficient funds')) {
      message = '账户余额不足'
    } else if (error?.message?.includes('gas')) {
      message = 'Gas费用不足，请调整Gas设置'
    } else if (error?.message?.includes('Already claimed')) {
      message = '您已经领取过这个红包了'
    } else if (error?.message?.includes('No packets left')) {
      message = '红包已被抢完'
    } else if (error?.message?.includes('Not exist')) {
      message = '红包不存在'
    } else if (error?.reason) {
      message = error.reason
    } else if (error?.message) {
      // 尝试从错误消息中提取更友好的信息
      const match = error.message.match(/reason="([^"]+)"/)
      if (match) {
        message = match[1]
      } else {
        message = error.message
      }
    }

    toast.error(message, { duration: 5000 })
  }

  // 全局错误处理
  useEffect(() => {
    const handleUnhandledError = (event: ErrorEvent) => {
      handleError(event.error)
    }

    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
      handleError(event.reason)
    }

    window.addEventListener('error', handleUnhandledError)
    window.addEventListener('unhandledrejection', handleUnhandledRejection)

    return () => {
      window.removeEventListener('error', handleUnhandledError)
      window.removeEventListener('unhandledrejection', handleUnhandledRejection)
    }
  }, [])

  return { handleError }
}
```

### 3. 性能优化

**src/hooks/useOptimizedQuery.ts**:
```typescript
import { useState, useEffect } from 'react'
import { useQuery } from '@apollo/client'

// 虚拟滚动Hook，用于大量数据的性能优化
export function useVirtualizedList<T>(
  items: T[],
  itemHeight: number,
  containerHeight: number
) {
  const [scrollTop, setScrollTop] = useState(0)
  
  const visibleStart = Math.floor(scrollTop / itemHeight)
  const visibleEnd = Math.min(
    visibleStart + Math.ceil(containerHeight / itemHeight) + 1,
    items.length
  )
  
  const visibleItems = items.slice(visibleStart, visibleEnd)
  
  return {
    visibleItems,
    visibleStart,
    visibleEnd,
    totalHeight: items.length * itemHeight,
    offsetY: visibleStart * itemHeight,
    onScroll: (e: React.UIEvent<HTMLDivElement>) => {
      setScrollTop(e.currentTarget.scrollTop)
    }
  }
}

// 智能轮询Hook，根据页面可见性调整轮询频率
export function useSmartPolling(baseInterval: number) {
  const [isVisible, setIsVisible] = useState(true)
  const [interval, setInterval] = useState(baseInterval)

  useEffect(() => {
    const handleVisibilityChange = () => {
      const visible = !document.hidden
      setIsVisible(visible)
      // 页面不可见时降低轮询频率
      setInterval(visible ? baseInterval : baseInterval * 3)
    }

    document.addEventListener('visibilitychange', handleVisibilityChange)
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange)
    }
  }, [baseInterval])

  return { interval, isVisible }
}

// 防抖Hook
export function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    return () => {
      clearTimeout(handler)
    }
  }, [value, delay])

  return debouncedValue
}
```

## 🚀 部署与优化

### 1. 环境变量配置

**.env**:
```bash
# 网络配置
VITE_SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_PROJECT_ID
VITE_WALLET_CONNECT_PROJECT_ID=your_wallet_connect_project_id

# 合约地址
VITE_RED_PACKET_CONTRACT=0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f

# 子图URL
VITE_SUBGRAPH_URL=https://api.studio.thegraph.com/query/your-subgraph

# 分析工具
VITE_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
```

### 2. 构建优化配置

**vite.config.ts**:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  build: {
    // 构建优化
    target: 'es2020',
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
      },
    },
    rollupOptions: {
      output: {
        // 代码分割
        manualChunks: {
          vendor: ['react', 'react-dom'],
          web3: ['wagmi', 'viem', '@tanstack/react-query'],
          graphql: ['@apollo/client', 'graphql'],
          ui: ['lucide-react', 'sonner'],
        },
      },
    },
    // 启用源映射用于生产调试
    sourcemap: true,
  },
  server: {
    // 开发服务器配置
    port: 3000,
    open: true,
    host: true,
  },
  preview: {
    port: 3001,
  },
})
```

### 3. SEO优化

**public/index.html**:
```html
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/red-packet-icon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>红包 DApp - 去中心化红包系统</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="去中心化红包系统，基于以太坊区块链，支持创建和抢夺ETH红包，安全透明" />
    <meta name="keywords" content="红包,DApp,以太坊,区块链,Web3,去中心化" />
    <meta name="author" content="Red Packet DApp Team" />
    
    <!-- Open Graph -->
    <meta property="og:title" content="红包 DApp - 去中心化红包系统" />
    <meta property="og:description" content="去中心化红包系统，基于以太坊区块链" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://red-packet-dapp.com" />
    <meta property="og:image" content="/og-image.jpg" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="红包 DApp" />
    <meta name="twitter:description" content="去中心化红包系统" />
    <meta name="twitter:image" content="/twitter-image.jpg" />
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

### 4. 部署脚本

**scripts/deploy.sh**:
```bash
#!/bin/bash

# 构建应用
echo "🏗️  构建应用..."
npm run build

# 检查构建结果
if [ ! -d "dist" ]; then
  echo "❌ 构建失败"
  exit 1
fi

echo "✅ 构建完成"

# 部署到Vercel (示例)
echo "🚀 部署到Vercel..."
npx vercel --prod

# 或者部署到其他平台
# echo "🚀 部署到Netlify..."
# npx netlify deploy --prod --dir=dist

echo "✅ 部署完成"

# 运行部署后验证
echo "🔍 验证部署..."
curl -f https://red-packet-dapp.vercel.app/health || echo "⚠️  健康检查失败"

echo "🎉 部署流程完成"
```

## 📚 最佳实践总结

### 1. 代码组织原则
- **组件单一职责**: 每个组件只负责一个功能
- **自定义Hooks**: 抽象业务逻辑，提高复用性
- **类型安全**: 全面使用TypeScript，减少运行时错误
- **错误边界**: 实现错误边界组件，优雅处理异常

### 2. 性能优化策略
- **代码分割**: 按路由和功能模块分割代码
- **懒加载**: 非关键组件延迟加载
- **缓存策略**: 合理使用React Query缓存
- **虚拟滚动**: 大量数据使用虚拟滚动

### 3. 用户体验优化
- **加载状态**: 所有异步操作显示加载状态
- **错误处理**: 友好的错误提示和恢复建议
- **实时更新**: 使用事件监听实现实时数据同步
- **响应式设计**: 适配各种设备屏幕

### 4. 安全性考虑
- **输入验证**: 所有用户输入进行前端验证
- **环境变量**: 敏感信息使用环境变量管理
- **HTTPS**: 生产环境强制使用HTTPS
- **内容安全策略**: 设置适当的CSP头

### 5. 开发效率提升
- **热重载**: 开发环境快速反馈
- **类型检查**: 编译时发现类型错误
- **代码格式化**: 使用Prettier和ESLint
- **Git Hooks**: 提交前自动检查代码质量

通过这套完整的前端开发指南，我们构建了一个现代化、高性能、用户友好的Web3红包应用。整个开发过程体现了现代前端开发的最佳实践，为类似的DApp项目提供了很好的参考模板。