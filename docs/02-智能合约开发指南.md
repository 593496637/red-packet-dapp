# ğŸ§§ æ™ºèƒ½åˆçº¦å¼€å‘è¯¦ç»†æŒ‡å—

## ğŸ“‹ å¼€å‘å‰å‡†å¤‡

### éœ€æ±‚åˆ†æ
åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®çº¢åŒ…ç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚ï¼š

1. **åŸºç¡€åŠŸèƒ½éœ€æ±‚**
   - ç”¨æˆ·å¯ä»¥åˆ›å»ºçº¢åŒ…ï¼Œå­˜å…¥ETH
   - è®¾ç½®çº¢åŒ…ä»½æ•°å’Œç¥ç¦è¯­
   - æ”¯æŒéšæœºå’Œå‡åˆ†ä¸¤ç§æ¨¡å¼
   - å…¶ä»–ç”¨æˆ·å¯ä»¥é¢†å–çº¢åŒ…
   - é˜²æ­¢é‡å¤é¢†å–
   - 24å°æ—¶ååˆ›å»ºè€…å¯æå–æœªé¢†å–èµ„é‡‘

2. **å®‰å…¨æ€§éœ€æ±‚**
   - é˜²æ­¢é‡å…¥æ”»å‡»
   - é˜²æ­¢æ•´æ•°æº¢å‡º
   - è®¿é—®æ§åˆ¶
   - èµ„é‡‘å®‰å…¨ä¿éšœ

3. **æ€§èƒ½éœ€æ±‚**
   - Gasä¼˜åŒ–
   - äº‹ä»¶å®Œæ•´æ€§
   - æŸ¥è¯¢æ•ˆç‡

### æŠ€æœ¯æ¶æ„è®¾è®¡

```
RedPacketSystem Contract
â”œâ”€â”€ æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ RedPacket struct      (çº¢åŒ…æ ¸å¿ƒæ•°æ®)
â”‚   â”œâ”€â”€ packetCounter        (çº¢åŒ…IDè®¡æ•°å™¨)
â”‚   â”œâ”€â”€ packets mapping      (çº¢åŒ…å­˜å‚¨)
â”‚   â””â”€â”€ hasClaimed mapping   (é¢†å–çŠ¶æ€è®°å½•)
â”œâ”€â”€ æ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ createRedPacket()    (åˆ›å»ºçº¢åŒ…)
â”‚   â”œâ”€â”€ claimRedPacket()     (é¢†å–çº¢åŒ…)
â”‚   â””â”€â”€ withdraw()           (æå–èµ„é‡‘)
â”œâ”€â”€ è¾…åŠ©åŠŸèƒ½
â”‚   â””â”€â”€ _getRandomAmount()   (éšæœºé‡‘é¢è®¡ç®—)
â””â”€â”€ äº‹ä»¶ç³»ç»Ÿ
    â”œâ”€â”€ PacketCreated
    â”œâ”€â”€ PacketClaimed
    â”œâ”€â”€ PacketEmpty
    â”œâ”€â”€ AlreadyClaimed
    â””â”€â”€ FundsWithdrawn
```

## ğŸ—ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. åˆå§‹åŒ–é¡¹ç›®

```bash
mkdir red-packet-contracts
cd red-packet-contracts
npm init -y
```

### 2. å®‰è£…Hardhatå’Œä¾èµ–

```bash
# å®‰è£…Hardhat 3 Beta
npm install --save-dev hardhat@^3.0.3

# å®‰è£…Hardhatå·¥å…·é“¾
npm install --save-dev @nomicfoundation/hardhat-toolbox-viem
npm install --save-dev @nomicfoundation/hardhat-ignition
npm install --save-dev @nomicfoundation/hardhat-verify

# å®‰è£…å…¶ä»–å¼€å‘ä¾èµ–
npm install --save-dev typescript @types/node
npm install --save-dev viem
npm install --save-dev forge-std

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
npm install dotenv
```

### 3. Hardhaté…ç½®

**hardhat.config.ts**:
```typescript
import type { HardhatUserConfig } from "hardhat/config";
import "dotenv/config";
import hardhatToolboxViemPlugin from "@nomicfoundation/hardhat-toolbox-viem";
import { configVariable } from "hardhat/config";
import "@nomicfoundation/hardhat-verify";

const config: HardhatUserConfig = {
  plugins: [hardhatToolboxViemPlugin],
  solidity: {
    profiles: {
      default: {
        version: "0.8.28",
      },
      production: {
        version: "0.8.28",
        settings: {
          optimizer: {
            enabled: true,
            runs: 200,
          },
        },
      },
    },
  },
  networks: {
    hardhatMainnet: {
      type: "edr-simulated",
      chainType: "l1",
    },
    sepolia: {
      type: "http",
      chainType: "l1",
      url: configVariable("SEPOLIA_RPC_URL"),
      accounts: [configVariable("SEPOLIA_PRIVATE_KEY")],
    },
  },
  verify: {
    etherscan: {
      apiKey: configVariable("ETHERSCAN_API_KEY"),
    },
  },
};

export default config;
```

**å…³é”®é…ç½®è¯´æ˜**:
- ä½¿ç”¨Solidity 0.8.28ï¼ŒåŒ…å«æœ€æ–°å®‰å…¨ç‰¹æ€§
- ç”Ÿäº§ç¯å¢ƒå¯ç”¨ä¼˜åŒ–å™¨ï¼Œruns=200å¹³è¡¡éƒ¨ç½²æˆæœ¬å’Œæ‰§è¡Œæˆæœ¬
- é…ç½®Sepoliaæµ‹è¯•ç½‘å’ŒEtherscanéªŒè¯
- ä½¿ç”¨configVariableå®‰å…¨ç®¡ç†ç§é’¥

### 4. ç¯å¢ƒå˜é‡é…ç½®

**.env**:
```bash
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_PROJECT_ID
SEPOLIA_PRIVATE_KEY=your_private_key_here
ETHERSCAN_API_KEY=your_etherscan_api_key
```

## ğŸ’¡ åˆçº¦è®¾è®¡ä¸å®ç°

### 1. æ•°æ®ç»“æ„è®¾è®¡

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

contract RedPacketSystem {
    // çº¢åŒ…ç»“æ„ä½“ - ç²¾å¿ƒè®¾è®¡çš„å­˜å‚¨å¸ƒå±€
    struct RedPacket {
        address owner;           // 20å­—èŠ‚ - åˆ›å»ºè€…åœ°å€
        string message;          // åŠ¨æ€é•¿åº¦ - ç¥ç¦è¯­
        uint256 totalAmount;     // 32å­—èŠ‚ - æ€»é‡‘é¢
        uint256 balance;         // 32å­—èŠ‚ - å‰©ä½™é‡‘é¢
        uint256 totalCount;      // 32å­—èŠ‚ - æ€»ä»½æ•°
        uint256 claimedCount;    // 32å­—èŠ‚ - å·²é¢†å–ä»½æ•°
        bool isEven;            // 1å­—èŠ‚ - æ˜¯å¦å‡åˆ†
        uint256 creationTime;    // 32å­—èŠ‚ - åˆ›å»ºæ—¶é—´
    }

    // å…¨å±€çŠ¶æ€å˜é‡
    uint256 public packetCounter;    // çº¢åŒ…IDè®¡æ•°å™¨
    
    // æ ¸å¿ƒå­˜å‚¨æ˜ å°„
    mapping(uint256 => RedPacket) public packets;           // packetId => RedPacket
    mapping(uint256 => mapping(address => bool)) public hasClaimed;  // é¢†å–çŠ¶æ€è®°å½•
}
```

**è®¾è®¡è€ƒè™‘**:
1. **å­˜å‚¨ä¼˜åŒ–**: å°†boolå’Œaddresså°½é‡æ”¾åœ¨ä¸€èµ·ï¼Œå‡å°‘å­˜å‚¨æ§½
2. **è®¿é—®æ•ˆç‡**: å¸¸ç”¨æ•°æ®æ”¾åœ¨å‰é¢ï¼Œå‡å°‘SLOADæ“ä½œ
3. **æ‰©å±•æ€§**: é¢„ç•™æ‰©å±•ç©ºé—´ï¼Œä¾¿äºåç»­å‡çº§
4. **å®‰å…¨æ€§**: ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹ï¼Œé˜²æ­¢æº¢å‡º

### 2. äº‹ä»¶ç³»ç»Ÿè®¾è®¡

```solidity
// å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¾¿äºå‰ç«¯ç›‘å¬å’Œå­å›¾ç´¢å¼•
event PacketCreated(
    uint256 indexed packetId,      // ç´¢å¼•ï¼šä¾¿äºæŒ‰çº¢åŒ…IDæŸ¥è¯¢
    address indexed creator,       // ç´¢å¼•ï¼šä¾¿äºæŒ‰åˆ›å»ºè€…æŸ¥è¯¢  
    string message,               // éç´¢å¼•ï¼šèŠ‚çœgas
    uint256 totalAmount,
    uint256 totalCount,
    bool isEven                   // æ–°å¢ï¼šåŒºåˆ†åˆ†å‘æ¨¡å¼
);

event PacketClaimed(
    uint256 indexed packetId,
    address indexed claimer,
    uint256 amount
);

event PacketEmpty(uint256 indexed packetId);

event AlreadyClaimed(
    uint256 indexed packetId, 
    address indexed claimer
);

event FundsWithdrawn(
    uint256 indexed packetId,
    address indexed owner,
    uint256 amount
);
```

**äº‹ä»¶è®¾è®¡åŸåˆ™**:
1. **ç´¢å¼•ç­–ç•¥**: æœ€å¤š3ä¸ªindexedå‚æ•°ï¼Œé€‰æ‹©æœ€å¸¸æŸ¥è¯¢çš„å­—æ®µ
2. **ä¿¡æ¯å®Œæ•´æ€§**: åŒ…å«å‰ç«¯æ¸²æŸ“éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯
3. **Gasä¼˜åŒ–**: å¤§æ•°æ®ä¸åšç´¢å¼•ï¼ŒèŠ‚çœgas
4. **å‘åå…¼å®¹**: æ–°å¢å­—æ®µæ”¾åœ¨æœ«å°¾

### 3. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### createRedPacket - åˆ›å»ºçº¢åŒ…

```solidity
/**
 * @dev åˆ›å»ºä¸€ä¸ªæ–°çº¢åŒ…
 * @param _message ç¥ç¦è¯­
 * @param _count çº¢åŒ…æ•°é‡  
 * @param _isEven æ˜¯å¦å‡åˆ†
 */
function createRedPacket(
    string memory _message,
    uint256 _count,
    bool _isEven
) external payable {
    // å‚æ•°éªŒè¯
    require(msg.value > 0, "RedPacket: Must send ETH to create");
    require(_count > 0, "RedPacket: Count must be greater than 0");
    require(
        msg.value >= _count,
        "RedPacket: Amount must be at least 1 wei per packet"
    );

    // ç”Ÿæˆæ–°çš„çº¢åŒ…ID
    uint256 packetId = ++packetCounter;
    
    // åˆ›å»ºçº¢åŒ…æ•°æ®
    packets[packetId] = RedPacket({
        owner: msg.sender,
        message: _message,
        totalAmount: msg.value,
        balance: msg.value,
        totalCount: _count,
        claimedCount: 0,
        isEven: _isEven,
        creationTime: block.timestamp
    });

    // å‘å‡ºåˆ›å»ºäº‹ä»¶
    emit PacketCreated(
        packetId,
        msg.sender,
        _message,
        msg.value,
        _count,
        _isEven
    );
}
```

**å®ç°è¦ç‚¹**:
1. **å‚æ•°éªŒè¯**: ä¸¥æ ¼éªŒè¯è¾“å…¥å‚æ•°ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®
2. **IDç®¡ç†**: ä½¿ç”¨é€’å¢è®¡æ•°å™¨ç”Ÿæˆå”¯ä¸€ID
3. **çŠ¶æ€åˆå§‹åŒ–**: æ­£ç¡®åˆå§‹åŒ–æ‰€æœ‰å­—æ®µ
4. **äº‹ä»¶å‘å‡º**: ç¡®ä¿äº‹ä»¶åŒ…å«å®Œæ•´ä¿¡æ¯

#### claimRedPacket - é¢†å–çº¢åŒ…

```solidity
/**
 * @dev æŠ¢çº¢åŒ…
 * @param _packetId çº¢åŒ…çš„ID
 */
function claimRedPacket(uint256 _packetId) external {
    RedPacket storage packet = packets[_packetId];

    // åŸºç¡€éªŒè¯
    require(packet.owner != address(0), "RedPacket: Not exist");
    require(
        packet.claimedCount < packet.totalCount,
        "RedPacket: No packets left"
    );
    
    // é‡å¤é¢†å–æ£€æŸ¥ - ä½¿ç”¨soft failè®¾è®¡
    if (hasClaimed[_packetId][msg.sender]) {
        emit AlreadyClaimed(_packetId, msg.sender);
        return; // è§¦å‘äº‹ä»¶ä½†ä¸revertï¼Œå¯¹å‰ç«¯æ›´å‹å¥½
    }

    // æ›´æ–°çŠ¶æ€
    hasClaimed[_packetId][msg.sender] = true;
    packet.claimedCount++;

    // è®¡ç®—é¢†å–é‡‘é¢
    uint256 amount;
    if (packet.claimedCount == packet.totalCount) {
        // æœ€åä¸€ä¸ªäººè·å¾—æ‰€æœ‰å‰©ä½™é‡‘é¢
        amount = packet.balance;
    } else {
        if (packet.isEven) {
            // å‡åˆ†æ¨¡å¼
            amount = packet.totalAmount / packet.totalCount;
        } else {
            // éšæœºæ¨¡å¼
            amount = _getRandomAmount(
                packet.balance,
                packet.totalCount - packet.claimedCount + 1
            );
        }
    }

    // é˜²æ­¢é‡‘é¢è¶…å‡ºä½™é¢
    if (amount > packet.balance) {
        amount = packet.balance;
    }

    packet.balance -= amount;

    // å®‰å…¨è½¬è´¦
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "RedPacket: Transfer failed");

    emit PacketClaimed(_packetId, msg.sender, amount);

    // çº¢åŒ…é¢†å®Œäº‹ä»¶
    if (packet.claimedCount == packet.totalCount) {
        emit PacketEmpty(_packetId);
    }
}
```

**æ ¸å¿ƒç®—æ³•è§£æ**:

1. **é‡‘é¢è®¡ç®—ç­–ç•¥**:
   - æœ€åä¸€äºº: è·å¾—æ‰€æœ‰å‰©ä½™é‡‘é¢ï¼Œç¡®ä¿èµ„é‡‘å®Œå…¨åˆ†é…
   - å‡åˆ†æ¨¡å¼: ç®€å•é™¤æ³•ï¼Œå¯èƒ½æœ‰å¾®å°ä½™é¢ç•™ç»™æœ€åä¸€äºº
   - éšæœºæ¨¡å¼: è°ƒç”¨éšæœºç®—æ³•ï¼Œä¿è¯å…¬å¹³æ€§

2. **çŠ¶æ€æ›´æ–°é¡ºåº**:
   - å…ˆæ ‡è®°å·²é¢†å– â†’ æ›´æ–°è®¡æ•° â†’ è®¡ç®—é‡‘é¢ â†’ æ›´æ–°ä½™é¢ â†’ è½¬è´¦
   - éµå¾ªCEIæ¨¡å¼(Checks-Effects-Interactions)

3. **é”™è¯¯å¤„ç†è®¾è®¡**:
   - é‡å¤é¢†å–ä½¿ç”¨soft failï¼Œæå‡ç”¨æˆ·ä½“éªŒ
   - è½¬è´¦å¤±è´¥ç›´æ¥revertï¼Œä¿è¯èµ„é‡‘å®‰å…¨

#### _getRandomAmount - éšæœºé‡‘é¢ç®—æ³•

```solidity
/**
 * @dev ç”Ÿæˆéšæœºé‡‘é¢ (å†…éƒ¨å‡½æ•°)
 * @param _balance å½“å‰ä½™é¢
 * @param _remainingCount å‰©ä½™ä»½æ•°
 */
function _getRandomAmount(
    uint256 _balance,
    uint256 _remainingCount
) private view returns (uint256) {
    if (_remainingCount == 0) return 0;
    
    // è®¡ç®—å¹³å‡å€¼
    uint256 avg = _balance / _remainingCount;
    
    // ç”Ÿæˆä¼ªéšæœºæ•°
    uint256 seed = uint256(
        keccak256(abi.encodePacked(block.timestamp, msg.sender, _balance))
    );
    uint256 random = (seed % (avg * 2)) + 1; // [1, avg*2]
    
    // ç¡®ä¿ä¸ºåç»­ç”¨æˆ·ä¿ç•™è‡³å°‘1wei
    uint256 maxAmount = _balance - (_remainingCount - 1);
    if (random > maxAmount) {
        random = maxAmount;
    }
    
    return random;
}
```

**ç®—æ³•è®¾è®¡æ€è·¯**:

1. **éšæœºæ€§æ¥æº**:
   - block.timestamp: æ—¶é—´æˆ³éšæœºæ€§
   - msg.sender: ç”¨æˆ·åœ°å€éšæœºæ€§
   - _balance: ä½™é¢éšæœºæ€§

2. **åˆ†å¸ƒç­–ç•¥**:
   - ä»¥å¹³å‡å€¼ä¸ºä¸­å¿ƒï¼ŒèŒƒå›´[1, avg*2]
   - ç¡®ä¿æ¯ä¸ªäººéƒ½èƒ½åˆ†åˆ°é’±ï¼Œæœ€å°1wei

3. **è¾¹ç•Œä¿æŠ¤**:
   - ä¸ºå‰©ä½™ç”¨æˆ·ä¿ç•™èµ„é‡‘
   - é˜²æ­¢æœ€åå‡ ä¸ªç”¨æˆ·æ— é’±å¯åˆ†

#### withdraw - èµ„é‡‘æå–

```solidity
/**
 * @dev åˆ›å»ºè€…åœ¨24å°æ—¶åå–å›å‰©ä½™é‡‘é¢
 * @param _packetId çº¢åŒ…ID
 */
function withdraw(uint256 _packetId) external {
    RedPacket storage packet = packets[_packetId];
    
    // æƒé™æ£€æŸ¥
    require(msg.sender == packet.owner, "RedPacket: Not owner");
    
    // æ—¶é—´æ£€æŸ¥
    require(
        block.timestamp > packet.creationTime + 24 hours,
        "RedPacket: Not expired yet"
    );
    
    // ä½™é¢æ£€æŸ¥
    require(packet.balance > 0, "RedPacket: No balance to withdraw");

    uint256 amountToWithdraw = packet.balance;
    packet.balance = 0; // å…ˆæ›´æ–°çŠ¶æ€ï¼Œé˜²æ­¢é‡å…¥

    // å®‰å…¨è½¬è´¦
    (bool success, ) = msg.sender.call{value: amountToWithdraw}("");
    require(success, "RedPacket: Withdraw failed");

    emit FundsWithdrawn(_packetId, msg.sender, amountToWithdraw);
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥ä¸å®ç°

### 1. æµ‹è¯•æ¶æ„è®¾è®¡

```
test/
â”œâ”€â”€ solidity/                 # Foundryå…¼å®¹çš„Solidityæµ‹è¯•
â”‚   â”œâ”€â”€ RedPacketSystem.t.sol
â”‚   â””â”€â”€ helpers/
â”‚       â””â”€â”€ TestHelpers.sol
â””â”€â”€ nodejs/                   # Node.jsé›†æˆæµ‹è¯•
    â”œâ”€â”€ RedPacketSystem.test.ts
    â””â”€â”€ fixtures/
        â””â”€â”€ deploy.ts
```

### 2. Solidityå•å…ƒæµ‹è¯•

**test/solidity/RedPacketSystem.t.sol**:
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import {Test} from "forge-std/Test.sol";
import {RedPacketSystem} from "../../contracts/RedPacketSystem.sol";

contract RedPacketSystemTest is Test {
    RedPacketSystem public redPacketSystem;
    address public owner = makeAddr("owner");
    address public user1 = makeAddr("user1");
    address public user2 = makeAddr("user2");

    function setUp() public {
        redPacketSystem = new RedPacketSystem();
        
        // ç»™æµ‹è¯•è´¦æˆ·ä¸€äº›ETH
        vm.deal(owner, 10 ether);
        vm.deal(user1, 1 ether);
        vm.deal(user2, 1 ether);
    }

    function testCreateRedPacket() public {
        vm.startPrank(owner);
        
        // æµ‹è¯•æˆåŠŸåˆ›å»º
        redPacketSystem.createRedPacket{value: 1 ether}("Happy New Year", 5, false);
        
        // éªŒè¯çŠ¶æ€
        (address packetOwner, string memory message, uint256 totalAmount, , uint256 totalCount, , bool isEven,) 
            = redPacketSystem.packets(1);
        
        assertEq(packetOwner, owner);
        assertEq(message, "Happy New Year");
        assertEq(totalAmount, 1 ether);
        assertEq(totalCount, 5);
        assertEq(isEven, false);
        
        vm.stopPrank();
    }

    function testCreateRedPacketFailures() public {
        vm.startPrank(owner);
        
        // æµ‹è¯•æ— ETHåˆ›å»º
        vm.expectRevert("RedPacket: Must send ETH to create");
        redPacketSystem.createRedPacket("test", 1, true);
        
        // æµ‹è¯•é›¶ä»½æ•°
        vm.expectRevert("RedPacket: Count must be greater than 0");
        redPacketSystem.createRedPacket{value: 1 ether}("test", 0, true);
        
        vm.stopPrank();
    }

    function testClaimRedPacket() public {
        // åˆ›å»ºçº¢åŒ…
        vm.prank(owner);
        redPacketSystem.createRedPacket{value: 1 ether}("test", 2, true);
        
        // é¢†å–çº¢åŒ…
        vm.prank(user1);
        redPacketSystem.claimRedPacket(1);
        
        // éªŒè¯çŠ¶æ€
        assertTrue(redPacketSystem.hasClaimed(1, user1));
        
        // éªŒè¯ä½™é¢å˜åŒ–
        (, , , uint256 balance, , uint256 claimedCount, ,) = redPacketSystem.packets(1);
        assertEq(claimedCount, 1);
        assertLt(balance, 1 ether); // ä½™é¢åº”è¯¥å‡å°‘
    }

    function testPreventDuplicateClaim() public {
        // åˆ›å»ºçº¢åŒ…
        vm.prank(owner);
        redPacketSystem.createRedPacket{value: 1 ether}("test", 2, true);
        
        // ç¬¬ä¸€æ¬¡é¢†å–
        vm.prank(user1);
        redPacketSystem.claimRedPacket(1);
        
        // ç¬¬äºŒæ¬¡é¢†å–åº”è¯¥å‘å‡ºAlreadyClaimedäº‹ä»¶ä½†ä¸revert
        vm.expectEmit(true, true, false, false);
        emit AlreadyClaimed(1, user1);
        
        vm.prank(user1);
        redPacketSystem.claimRedPacket(1);
    }

    function testWithdrawAfterExpiry() public {
        // åˆ›å»ºçº¢åŒ…
        vm.prank(owner);
        redPacketSystem.createRedPacket{value: 1 ether}("test", 2, true);
        
        // æ—¶é—´å¿«è¿›24å°æ—¶
        vm.warp(block.timestamp + 24 hours + 1);
        
        // æå–èµ„é‡‘
        uint256 balanceBefore = owner.balance;
        vm.prank(owner);
        redPacketSystem.withdraw(1);
        
        // éªŒè¯ä½™é¢å˜åŒ–
        assertGt(owner.balance, balanceBefore);
    }
}
```

### 3. Node.jsé›†æˆæµ‹è¯•

**test/nodejs/RedPacketSystem.test.ts**:
```typescript
import { test, describe, beforeEach } from "node:test";
import { strict as assert } from "node:assert";
import { createPublicClient, createWalletClient, http, parseEther, formatEther } from "viem";
import { hardhat } from "viem/chains";
import { deployContract } from "./fixtures/deploy";

describe("RedPacketSystem Integration Tests", () => {
  let publicClient: any;
  let walletClient: any;
  let contractAddress: string;
  let accounts: string[];

  beforeEach(async () => {
    // åˆå§‹åŒ–å®¢æˆ·ç«¯
    publicClient = createPublicClient({
      chain: hardhat,
      transport: http(),
    });

    walletClient = createWalletClient({
      chain: hardhat,  
      transport: http(),
    });

    // è·å–æµ‹è¯•è´¦æˆ·
    accounts = await walletClient.getAddresses();

    // éƒ¨ç½²åˆçº¦
    const { address } = await deployContract(walletClient);
    contractAddress = address;
  });

  test("å®Œæ•´çš„çº¢åŒ…æµç¨‹", async () => {
    const [owner, user1, user2] = accounts;

    // 1. åˆ›å»ºçº¢åŒ…
    const createTx = await walletClient.writeContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "createRedPacket",
      args: ["æ–°å¹´å¿«ä¹", 2n, false],
      value: parseEther("1"),
      account: owner,
    });

    await publicClient.waitForTransactionReceipt({ hash: createTx });

    // 2. éªŒè¯çº¢åŒ…åˆ›å»º
    const packet = await publicClient.readContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "packets",
      args: [1n],
    });

    assert.equal(packet[0], owner); // owner
    assert.equal(packet[1], "æ–°å¹´å¿«ä¹"); // message
    assert.equal(packet[2], parseEther("1")); // totalAmount

    // 3. ç”¨æˆ·é¢†å–çº¢åŒ…
    const claimTx1 = await walletClient.writeContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "claimRedPacket",
      args: [1n],
      account: user1,
    });

    await publicClient.waitForTransactionReceipt({ hash: claimTx1 });

    // 4. éªŒè¯é¢†å–çŠ¶æ€
    const hasClaimed = await publicClient.readContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "hasClaimed",
      args: [1n, user1],
    });

    assert.equal(hasClaimed, true);
  });

  test("Gasä½¿ç”¨é‡æµ‹è¯•", async () => {
    const [owner] = accounts;

    const createTx = await walletClient.writeContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "createRedPacket",
      args: ["test", 10n, false],
      value: parseEther("1"),
      account: owner,
    });

    const receipt = await publicClient.waitForTransactionReceipt({ 
      hash: createTx 
    });

    console.log(`åˆ›å»ºçº¢åŒ…Gasä½¿ç”¨é‡: ${receipt.gasUsed}`);
    
    // éªŒè¯Gasä½¿ç”¨é‡åœ¨åˆç†èŒƒå›´å†…
    assert(receipt.gasUsed < 200000n, "åˆ›å»ºçº¢åŒ…Gasä½¿ç”¨é‡è¿‡é«˜");
  });
});
```

## ğŸš€ éƒ¨ç½²ä¸éªŒè¯

### 1. éƒ¨ç½²è„šæœ¬ç¼–å†™

**ignition/modules/RedPacketSystem.ts**:
```typescript
import { buildModule } from "@nomicfoundation/hardhat-ignition/modules";

export default buildModule("RedPacketSystemModule", (m) => {
  // éƒ¨ç½²RedPacketSystemåˆçº¦
  const redPacketSystem = m.contract("RedPacketSystem", []);

  return {
    redPacketSystem,
  };
});
```

### 2. éƒ¨ç½²åˆ°Sepolia

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
npx hardhat keystore set SEPOLIA_PRIVATE_KEY
npx hardhat keystore set SEPOLIA_RPC_URL  
npx hardhat keystore set ETHERSCAN_API_KEY

# æ‰§è¡Œéƒ¨ç½²
npx hardhat ignition deploy ignition/modules/RedPacketSystem.ts --network sepolia

# éªŒè¯åˆçº¦
npx hardhat verify --network sepolia <CONTRACT_ADDRESS>
```

### 3. éƒ¨ç½²åéªŒè¯

```typescript
// scripts/verify-deployment.ts
import { createPublicClient, http } from "viem";
import { sepolia } from "viem/chains";

async function verifyDeployment() {
  const publicClient = createPublicClient({
    chain: sepolia,
    transport: http(process.env.SEPOLIA_RPC_URL),
  });

  const contractAddress = "0x4e659F1DB6E5475800A6E8d12F0f6dd25c65960f";

  // æ£€æŸ¥åˆçº¦æ˜¯å¦éƒ¨ç½²æˆåŠŸ
  const code = await publicClient.getBytecode({ 
    address: contractAddress 
  });
  
  if (code && code !== "0x") {
    console.log("âœ… åˆçº¦éƒ¨ç½²æˆåŠŸ");
    
    // æ£€æŸ¥packetCounteræ˜¯å¦ä¸º0
    const counter = await publicClient.readContract({
      address: contractAddress,
      abi: redPacketAbi,
      functionName: "packetCounter",
    });
    
    console.log(`ğŸ“Š å½“å‰çº¢åŒ…è®¡æ•°å™¨: ${counter}`);
  } else {
    console.log("âŒ åˆçº¦éƒ¨ç½²å¤±è´¥");
  }
}
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘ä¸å®¡è®¡

### 1. å®‰å…¨å¨èƒåˆ†æ

**é‡å…¥æ”»å‡»é˜²æŠ¤**:
```solidity
// âŒ é”™è¯¯çš„å®ç°
function claimRedPacket(uint256 _packetId) external {
    uint256 amount = calculateAmount();
    (bool success, ) = msg.sender.call{value: amount}(""); // å…ˆè½¬è´¦
    require(success, "Transfer failed");
    
    packet.balance -= amount; // åæ›´æ–°çŠ¶æ€ - å±é™©!
}

// âœ… æ­£ç¡®çš„å®ç°
function claimRedPacket(uint256 _packetId) external {
    uint256 amount = calculateAmount();
    packet.balance -= amount; // å…ˆæ›´æ–°çŠ¶æ€
    
    (bool success, ) = msg.sender.call{value: amount}(""); // åè½¬è´¦
    require(success, "Transfer failed");
}
```

**æ•´æ•°æº¢å‡ºé˜²æŠ¤**:
```solidity
// Solidity 0.8+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼Œä½†ä»éœ€æ³¨æ„è¾¹ç•Œæƒ…å†µ
require(msg.value >= _count, "Amount must be at least 1 wei per packet");
require(_count > 0, "Count must be greater than 0");
```

**è®¿é—®æ§åˆ¶**:
```solidity
// åªæœ‰åˆ›å»ºè€…å¯ä»¥æå–
require(msg.sender == packet.owner, "RedPacket: Not owner");

// åªæœ‰åœ¨è¿‡æœŸåæ‰èƒ½æå–
require(
    block.timestamp > packet.creationTime + 24 hours,
    "RedPacket: Not expired yet"
);
```

### 2. Gasä¼˜åŒ–æŠ€å·§

**å­˜å‚¨ä¼˜åŒ–**:
```solidity
// âŒ Gasæ˜‚è´µçš„å†™æ³•
function inefficientUpdate(uint256 _packetId) external {
    packets[_packetId].claimedCount++;          // SSTORE
    packets[_packetId].balance -= amount;       // SSTORE  
}

// âœ… Gasä¼˜åŒ–çš„å†™æ³•
function efficientUpdate(uint256 _packetId) external {
    RedPacket storage packet = packets[_packetId]; // ä¸€æ¬¡SLOAD
    packet.claimedCount++;                         // SSTORE
    packet.balance -= amount;                      // SSTORE
}
```

**äº‹ä»¶ä¼˜åŒ–**:
```solidity
// æœ€å¤š3ä¸ªindexedå‚æ•°ï¼Œé€‰æ‹©æœ€é‡è¦çš„
event PacketClaimed(
    uint256 indexed packetId,  // ç”¨äºè¿‡æ»¤
    address indexed claimer,   // ç”¨äºè¿‡æ»¤
    uint256 amount            // ä¸ç´¢å¼•ï¼ŒèŠ‚çœgas
);
```

### 3. ä»£ç å®¡è®¡æ¸…å•

**åŠŸèƒ½æ€§å®¡è®¡**:
- [ ] æ‰€æœ‰å‡½æ•°éƒ½èƒ½æ­£ç¡®æ‰§è¡Œ
- [ ] è¾¹ç•Œæ¡ä»¶å¤„ç†æ­£ç¡®
- [ ] äº‹ä»¶å‘å‡ºå®Œæ•´
- [ ] çŠ¶æ€æ›´æ–°åŸå­æ€§

**å®‰å…¨æ€§å®¡è®¡**:
- [ ] æ— é‡å…¥æ”»å‡»é£é™©
- [ ] æ— æ•´æ•°æº¢å‡ºé£é™©  
- [ ] è®¿é—®æ§åˆ¶æ­£ç¡®
- [ ] éšæœºæ•°å®‰å…¨æ€§

**ç»æµæ¨¡å‹å®¡è®¡**:
- [ ] èµ„é‡‘æµå…¥æµå‡ºå¹³è¡¡
- [ ] æ— èµ„é‡‘é”å®šé£é™©
- [ ] æ¿€åŠ±æœºåˆ¶åˆç†

**Gasä¼˜åŒ–å®¡è®¡**:
- [ ] å­˜å‚¨è®¿é—®ä¼˜åŒ–
- [ ] è®¡ç®—å¤æ‚åº¦åˆç†
- [ ] äº‹ä»¶å‚æ•°ä¼˜åŒ–

## ğŸ“š çŸ¥è¯†æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯èƒ½åŠ›
1. **Solidityè¯­è¨€ç²¾é€š**: è¯­æ³•ã€æœ€ä½³å®è·µã€å®‰å…¨æ¨¡å¼
2. **æ™ºèƒ½åˆçº¦è®¾è®¡**: æ•°æ®ç»“æ„ã€çŠ¶æ€ç®¡ç†ã€äº‹ä»¶ç³»ç»Ÿ
3. **å®‰å…¨ç¼–ç¨‹**: é‡å…¥é˜²æŠ¤ã€æº¢å‡ºæ£€æŸ¥ã€è®¿é—®æ§åˆ¶
4. **Gasä¼˜åŒ–**: å­˜å‚¨å¸ƒå±€ã€è®¡ç®—ä¼˜åŒ–ã€äº‹ä»¶è®¾è®¡
5. **æµ‹è¯•é©±åŠ¨å¼€å‘**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•

### å·¥å…·é“¾æŒæ¡
1. **Hardhat 3**: é…ç½®ã€ç¼–è¯‘ã€æµ‹è¯•ã€éƒ¨ç½²
2. **Foundry**: Solidityæµ‹è¯•ã€Gasåˆ†æ
3. **Viem**: ç°ä»£åŒ–çš„ä»¥å¤ªåŠäº¤äº’åº“
4. **Node.js Test Runner**: åŸç”Ÿæµ‹è¯•æ¡†æ¶

### æœ€ä½³å®è·µæ€»ç»“
1. **CEIæ¨¡å¼**: Checks-Effects-Interactions
2. **é˜²å¾¡æ€§ç¼–ç¨‹**: å‚æ•°éªŒè¯ã€è¾¹ç•Œæ£€æŸ¥ã€é”™è¯¯å¤„ç†
3. **æµ‹è¯•å…ˆè¡Œ**: æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå®Œæ•´è¦†ç›–
4. **æ–‡æ¡£å®Œå–„**: æ³¨é‡Šæ¸…æ™°ã€æ–‡æ¡£å®Œæ•´
5. **ç‰ˆæœ¬æ§åˆ¶**: åˆç†çš„Gitå·¥ä½œæµ

é€šè¿‡è¿™ä¸ªæ™ºèƒ½åˆçº¦çš„å¼€å‘è¿‡ç¨‹ï¼Œæˆ‘ä»¬æŒæ¡äº†ä»éœ€æ±‚åˆ†æåˆ°éƒ¨ç½²éªŒè¯çš„å®Œæ•´æµç¨‹ï¼Œè¿™æ˜¯Web3å¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ã€‚